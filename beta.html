<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jxo OS</title>
    <link rel="stylesheet" href="assets/css/default.css" />
    <style>
      /* Base and existing styles remain unchanged */
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        margin: 0;
      }
      /* Taskbar (existing) */
      #taskbar {
        position: fixed;
        bottom: 0;
        width: 100%;
        background-color: #1f1f1f;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px 10px;
        z-index: 1000;
      }
      .taskbar-button {
        background: none;
        border: none;
        cursor: pointer;
      }
      #start-button img,
      #gm-button img {
        width: 24px;
        height: 24px;
        vertical-align: middle;
      }
      /* --- NEW UPDATE: System Menu Button --- */
      #systemMenuBtn {
        display: flex;
        align-items: center;
        cursor: pointer;
      }
      #systemMenuBtn img {
        width: 24px;
        height: 24px;
        margin-right: 5px;
      }
      /* System Menu (new) */
      #systemMenu {
        position: fixed;
        bottom: 50px;
        right: 10px;
        background-color: #333;
        border: 1px solid #444;
        padding: 10px;
        z-index: 2000;
        display: none;
      }
      #systemMenu .menuItem {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
      }
      #systemMenu .menuItem img {
        width: 24px;
        height: 24px;
        margin-right: 5px;
      }
      #systemMenu .batteryInfo {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 10px;
      }
      #systemMenu .batteryInfo img {
        width: 24px;
        height: 24px;
        margin-right: 5px;
      }
      /* --- END NEW UPDATE: System Menu Button --- */
      
      /* --- Existing Game Bar styles remain (it is hidden by default, shown when clicked) --- */
      #gameBar {
        position: fixed;
        top: 0;
        width: 100%;
        background-color: rgba(0,0,0,0.9);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 5px 10px;
        z-index: 1500;
      }
      #gameBar button {
        background-color: #444;
        border: none;
        color: #e0e0e0;
        font-size: 24px;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        margin: 0 5px;
      }
      #gm-launcher {
        margin: 0 10px;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
      }
      #gm-launcher img {
        width: 24px;
        height: 24px;
        margin-right: 5px;
      }
      #clockWidget, #batteryWidget {
        margin-left: 20px;
        font-size: 18px;
      }
      /* --- End Game Bar --- */
      
      /* Desktop icons, Setup Screen, etc. remain unchanged... */
      
      /* Responsive adjustments */
      @media (max-width: 600px) {
        .desktop-app img {
          width: 48px;
          height: 48px;
        }
        #taskbar {
          padding: 5px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Setup/Boot screens and Desktop will be loaded dynamically -->
    <div id="setupContainer"></div>
    <div id="bootScreen" class="hidden"></div>
    <div id="desktop" class="hidden"></div>

    <!-- Taskbar with updated system menu button -->
    <div id="taskbar" class="hidden">
      <button id="start-button" class="taskbar-button">‚ùñ</button>
      <button id="gm-button" class="taskbar-button" onclick="toggleGameBar()">
        <img id="gm-icon" src="images/icons/gm/off.png" alt="Game Mode">
      </button>
      <!-- New system menu button -->
      <button id="systemMenuBtn" class="taskbar-button">
        <img src="images/icons/wifi.png" alt="WiFi">
        <img src="images/icons/battery.png" alt="Battery">
        <span id="batteryPercent">--%</span>
      </button>
      <div id="open-apps"></div>
      <div id="taskbar-right">
        <div id="clock-container">
          <span id="date"></span>
          <span id="clock"></span>
        </div>
        <button class="lock-button" onclick="showPasswordModal()">Lock</button>
        <button onclick="powerOff()">Power Down</button>
      </div>
    </div>

    <!-- System Menu (new) -->
    <div id="systemMenu">
      <div class="menuItem">
        <img src="images/icons/minimenu/jfi.png" alt="Jfi">
        <span>Jfi</span>
      </div>
      <div class="menuItem">
        <img src="images/icons/minimenu/connect.png" alt="Connect">
        <span>Connect</span>
      </div>
      <div class="menuItem">
        <img src="images/icons/minimenu/brightness.png" alt="Brightness">
        <input type="range" id="brightnessSlider" min="0" max="100" value="50">
      </div>
      <div class="batteryInfo">
        <img src="images/icons/battery.png" alt="Battery">
        <span id="batteryPercentBottom">--%</span>
      </div>
    </div>

    <!-- Game Bar (unchanged from before; remains hidden by default, appears when GM button clicked) -->
    <div id="gameBar" class="hidden">
      <button id="prevAppBtn" onclick="cycleApp(-1)">&#9664;</button>
      <div id="appDisplay" onclick="launchGMApp()"></div>
      <button id="nextAppBtn" onclick="cycleApp(1)">&#9654;</button>
      <div id="clockWidget"></div>
      <div id="batteryWidget"></div>
    </div>

    <!-- Scripts: Only updated functions are added/modified below -->
    <script>
      /* ----- System Menu and Taskbar Battery Update ----- */
      const systemMenuBtn = document.getElementById("systemMenuBtn");
      const systemMenu = document.getElementById("systemMenu");
      systemMenuBtn.addEventListener("click", () => {
        systemMenu.style.display = systemMenu.style.display === "none" || systemMenu.style.display === "" ? "block" : "none";
      });
      
      function updateSystemBattery() {
        const batteryPercentElem = document.getElementById("batteryPercent");
        const batteryPercentBottomElem = document.getElementById("batteryPercentBottom");
        if (navigator.getBattery) {
          navigator.getBattery().then(battery => {
            let level = Math.round(battery.level * 100) + "%";
            batteryPercentElem.textContent = level;
            batteryPercentBottomElem.textContent = level;
          });
        } else {
          batteryPercentElem.textContent = "N/A";
          batteryPercentBottomElem.textContent = "N/A";
        }
      }
      updateSystemBattery();
      setInterval(updateSystemBattery, 60000);
      
      /* ----- Brightness Slider ----- */
      const brightnessSlider = document.getElementById("brightnessSlider");
      brightnessSlider.addEventListener("input", () => {
        document.body.style.filter = `brightness(${brightnessSlider.value}%)`;
      });
      
      /* ----- Game Bar Functions (unchanged logic) ----- */
      function toggleGameBar() {
        const gb = document.getElementById("gameBar");
        if (gb.classList.contains("hidden")) {
          gb.classList.remove("hidden");
          document.getElementById("gm-icon").src = "images/icons/gm/on.png";
          gmApps = installedApps.filter(app => app.name !== "Settings" && app.name !== "Jstore");
          if (gmApps.length > 0) {
            gmCurrentIndex = Math.floor(Math.random() * gmApps.length);
            updateGMLauncher();
          }
          startGamepadPolling();
        } else {
          gb.classList.add("hidden");
          document.getElementById("gm-icon").src = "images/icons/gm/off.png";
          stopGamepadPolling();
        }
      }
      function updateGMLauncher() {
        const display = document.getElementById("appDisplay");
        if (gmApps.length === 0) { display.textContent = "No apps available"; return; }
        const app = gmApps[gmCurrentIndex];
        display.innerHTML = `<img src="${app.image}" alt="${app.name} icon">${app.name}`;
      }
      function cycleApp(direction) {
        if (gmApps.length === 0) return;
        gmCurrentIndex = (gmCurrentIndex + direction + gmApps.length) % gmApps.length;
        updateGMLauncher();
      }
      function launchGMApp() {
        if (gmApps.length === 0) return;
        const app = gmApps[gmCurrentIndex];
        if (app.htmlUrl) {
          let url = app.htmlUrl;
          url += (url.indexOf("?") === -1) ? "?controller=true" : "&controller=true";
          openAppWindowWithUrl(app.appId, url);
        } else { openAppWindow(app.appId); }
      }
      function openAppWindowWithUrl(appId, url) {
        const app = installedApps.find(app => app.appId === appId);
        if (app && !document.getElementById(appId)) {
          const win = document.createElement("div");
          win.classList.add("app-window");
          win.id = appId;
          win.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close">
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen">
                </button>
              </div>
            </div>
            <div class="window-content">
              <iframe src="${url}" width="100%" height="100%" style="border:none;"></iframe>
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(win);
          makeDraggable(win);
          makeResizable(win);
          openApps.push(appId);
          updateTaskbar();
        }
      }
      function startGamepadPolling() {
        if (gamepadInterval) return;
        gamepadInterval = setInterval(() => {
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          if (!gamepads) return;
          for (let gp of gamepads) {
            if (gp) {
              if (gp.buttons[14] && gp.buttons[14].pressed) { cycleApp(-1); }
              if (gp.buttons[15] && gp.buttons[15].pressed) { cycleApp(1); }
              if (gp.buttons[0] && gp.buttons[0].pressed) { launchGMApp(); }
              let axis = gp.axes[0];
              if (axis < -0.5) { cycleApp(-1); }
              if (axis > 0.5) { cycleApp(1); }
            }
          }
        }, 100);
      }
      function stopGamepadPolling() {
        if (gamepadInterval) { clearInterval(gamepadInterval); gamepadInterval = null; }
      }
      /* ----- Widgets Menu Placeholder ----- */
      function toggleWidgetsMenu() {
        const wm = document.getElementById("widgetsMenu");
        wm.classList.toggle("hidden");
      }
      function initWidgetsMenu() {
        if (!document.getElementById("widgetsMenu")) {
          const wm = document.createElement("div");
          wm.id = "widgetsMenu";
          wm.classList.add("hidden");
          wm.innerHTML = `
            <div class="widget" id="widget-spotify">Spotify Player (Placeholder)</div>
            <div class="widget" id="widget-clock">Clock Widget (Placeholder)</div>
          `;
          document.body.appendChild(wm);
          makeDraggable(wm);
        }
      }
      /* ----- Utility Functions (Draggable/Resizable) ----- */
      function makeDraggable(el) {
        const header = el.querySelector(".window-header") || el;
        let isDragging = false, offsetX = 0, offsetY = 0;
        header.addEventListener("mousedown", e => { isDragging = true; offsetX = e.clientX - el.offsetLeft; offsetY = e.clientY - el.offsetTop; });
        el.addEventListener("mousemove", e => { if (isDragging) { el.style.left = `${e.clientX - offsetX}px`; el.style.top = `${e.clientY - offsetY}px`; } });
        el.addEventListener("mouseup", () => { isDragging = false; });
      }
      function makeResizable(el) {
        const handle = el.querySelector(".resize-handle");
        let isResizing = false, lastX, lastY;
        handle.addEventListener("mousedown", e => { isResizing = true; lastX = e.clientX; lastY = e.clientY; e.preventDefault(); });
        window.addEventListener("mousemove", e => { if (isResizing) { const dx = e.clientX - lastX, dy = e.clientY - lastY; el.style.width = el.offsetWidth + dx + "px"; el.style.height = el.offsetHeight + dy + "px"; lastX = e.clientX; lastY = e.clientY; } });
        window.addEventListener("mouseup", () => { isResizing = false; });
      }
      function updateClock() {
        const now = new Date();
        document.getElementById("clock").textContent = now.toLocaleTimeString();
        document.getElementById("date").textContent = now.toLocaleDateString();
      }
      
      /* ----- Password Modal ----- */
      function showPasswordModal() {
        let modal = document.createElement("div");
        modal.classList.add("password-modal");
        let profilePic = localStorage.getItem("profilePic") || "images/icons/profile/profile.png";
        if (localStorage.getItem("password")) {
          let usernameField = localStorage.getItem("username")
            ? `<p>Welcome, ${localStorage.getItem("username")}!</p>`
            : `<input type="text" id="username-input" placeholder="Enter your username">`;
          modal.innerHTML = `
            <div class="password-modal-content">
              <img src="${profilePic}" alt="Profile Icon">
              ${usernameField}
              <h3>Enter Password</h3>
              <div style="display:inline-flex; align-items:center;">
                <input type="password" id="entered-password" placeholder="Enter password">
                <button class="toggle-password" onclick="toggleInputPassword('entered-password', this)">
                  <img src="images/icons/setup/show.png" alt="Show">
                </button>
              </div>
              <br>
              <button onclick="checkPassword()">Enter</button>
            </div>
          `;
        } else {
          modal.innerHTML = `
            <div class="password-modal-content">
              <img src="${profilePic}" alt="Profile Icon">
              <h3>Set up your account</h3>
              <input type="text" id="username-input" placeholder="Enter your username">
              <br>
              <input type="password" id="new-password" placeholder="Enter new password">
              <br>
              <button onclick="setCredentials()">Set Credentials</button>
            </div>
          `;
        }
        document.body.appendChild(modal);
      }
      function checkPassword() {
        const entered = document.getElementById("entered-password").value;
        const stored = localStorage.getItem("password");
        if (entered === stored) { document.querySelector(".password-modal").remove(); }
        else { alert("Incorrect password!"); }
      }
      function setCredentials() {
        const username = document.getElementById("username-input").value;
        const newPass = document.getElementById("new-password").value;
        if (username && newPass) {
          localStorage.setItem("username", username);
          localStorage.setItem("password", newPass);
          document.querySelector(".password-modal").remove();
        } else { alert("Username and password cannot be empty!"); }
      }
      function toggleInputPassword(id, btn) {
        const input = document.getElementById(id);
        if (input.type === "password") { input.type = "text"; btn.innerHTML = `<img src="images/icons/setup/hide.png" alt="Hide">`; }
        else { input.type = "password"; btn.innerHTML = `<img src="images/icons/setup/show.png" alt="Show">`; }
      }
      
      /* ----- Initialization ----- */
      document.addEventListener("DOMContentLoaded", () => {
        // Setup screen (if not complete) or boot screen.
        if (localStorage.getItem("setupComplete") !== "true") { showSetupScreen(); }
        else { showBootScreen(); }
        // Dummy installed apps for demo.
        if (!localStorage.getItem("installedApps")) {
          installedApps = [
            { name: "Jstore", appId: "jstore", image: "apps/icons/jstore.png", htmlUrl: "" },
            { name: "Settings", appId: "settings", image: "apps/icons/settings.png", htmlUrl: "" },
            { name: "Browser", appId: "browser", image: "apps/icons/browser.png", htmlUrl: "https://example.com" }
          ];
          localStorage.setItem("installedApps", JSON.stringify(installedApps));
        } else {
          installedApps = JSON.parse(localStorage.getItem("installedApps"));
        }
        // Update taskbar clock
        setInterval(updateClock, 1000);
        // Initialize widgets menu (placeholder)
        initWidgetsMenu();
      });
    </script>
  </body>
</html>
