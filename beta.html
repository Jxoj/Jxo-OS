<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="images/icons/favicon.png" type="image/png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jxo OS</title>
    <link rel="stylesheet" href="assets/css/default.css" />
    <style>
      /* Dark Theme Base */
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        margin: 0;
      }
      .taskbar {
        background-color: #1f1f1f;
        border-top: 1px solid #333;
        display: flex;
        align-items: center;
        padding: 0 10px;
      }
      /* Adjust desktop icon scale */
      .desktop-app img {
        width: 64px;
        height: 64px;
      }
      /* Open apps icons on taskbar */
      #open-apps img {
        width: 32px;
        height: 32px;
      }
      /* Start menu (search menu) styling modifications */
      #search-menu {
        background-color: #2a2a2a;
        max-height: 70vh;
        overflow-y: auto;
        padding: 10px;
      }
      #search-menu .close-btn {
        cursor: pointer;
      }
      #search-menu .close-btn img {
        width: 16px;
        height: 16px;
      }
      #search-menu input[type="text"] {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 10px;
        background-color: #333;
        border: none;
        border-radius: 5px;
        color: #e0e0e0;
        font-size: 16px;
      }
      /* App list styling */
      #app-list {
        display: flex;
        flex-direction: column;
      }
      #app-list .app-item {
        display: flex;
        align-items: center;
        padding: 5px;
        border-bottom: 1px solid #444;
      }
      #app-list .app-item img {
        width: 32px;
        height: 32px;
        margin-right: 10px;
      }
      /* Start menu and GM button icons */
      #start-button img,
      #gm-button img {
        width: 24px;
        height: 24px;
        vertical-align: middle;
      }
      /* Jstore content styling */
      #jstore-container {
        padding: 20px;
      }
      #jstore-container h1 {
        margin-bottom: 10px;
      }
      #jstore-search {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #333;
        border: none;
        border-radius: 5px;
        color: #e0e0e0;
        font-size: 16px;
      }
      .jstore-app-item {
        background-color: #222;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      .jstore-app-item img {
        width: 48px;
        height: 48px;
        margin-right: 10px;
      }
      .jstore-app-item button {
        margin-left: auto;
        padding: 5px 10px;
        background-color: #444;
        color: #e0e0e0;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .jstore-app-item button:hover {
        background-color: #555;
      }
      /* Settings UI */
      #settings-app {
        display: flex;
        height: calc(100vh - 50px);
        background-color: #1a1a1a;
      }
      #settings-sidebar {
        width: 250px;
        background-color: #2b2b2b;
        padding: 20px;
        box-shadow: inset -1px 0 0 rgba(255,255,255,0.1);
      }
      #settings-sidebar input[type="text"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 15px;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: #333;
        color: #e0e0e0;
      }
      #settings-options {
        list-style: none;
        padding: 0;
      }
      #settings-options li {
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        display: flex;
        align-items: center;
      }
      #settings-options li:hover {
        background-color: #444;
      }
      #settings-options li.active {
        background-color: #555;
      }
      #settings-options li img {
        width: 24px;
        margin-right: 10px;
      }
      #settings-content {
        flex-grow: 1;
        padding: 30px;
        background-color: #222;
        border-left: 1px solid #333;
        overflow: visible;
      }
      #settings-content h2 {
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 24px;
      }
      #settings-content h3 {
        margin-top: 20px;
        font-size: 20px;
      }
      /* Personalization elements */
      #bg-preview-container {
        border: 1px solid #444;
        padding: 10px;
        margin-bottom: 10px;
        text-align: center;
      }
      #bg-preview {
        max-width: 300px;
        max-height: 200px;
      }
      select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #444;
        background-color: #333;
        color: #e0e0e0;
        margin-top: 10px;
        position: relative;
        z-index: 10;
        max-width: 100%;
        box-sizing: border-box;
      }
      /* Setup Screen Styles */
      .setup-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #121212;
        color: #e0e0e0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        padding: 20px;
        box-sizing: border-box;
      }
      .setup-step {
        max-width: 500px;
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }
      .setup-step input, .setup-step select {
        width: 90%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: inherit;
        color: inherit;
      }
      .setup-step button {
        padding: 10px 20px;
        background-color: #444;
        border: none;
        border-radius: 4px;
        color: #e0e0e0;
        cursor: pointer;
        margin: 5px;
      }
      .setup-step button:hover {
        background-color: #555;
      }
      /* Styled File Input for Profile Pic */
      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin: 10px 0;
      }
      .file-input-wrapper input[type="file"] {
        opacity: 0;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .file-input-label {
        display: inline-block;
        padding: 10px 20px;
        background-color: #444;
        border-radius: 4px;
        cursor: pointer;
      }
      .preview-img {
        max-width: 100px;
        max-height: 100px;
        margin: 10px auto;
        display: block;
      }
      /* Toggle Password Button */
      .toggle-password {
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        margin-left: 5px;
      }
      .toggle-password img {
        width: 16px;
        height: 16px;
        vertical-align: middle;
      }
      /* Lock Button on Taskbar */
      .lock-button {
        padding: 5px 10px;
        background-color: #444;
        border: none;
        border-radius: 4px;
        color: #e0e0e0;
        cursor: pointer;
        margin-right: 10px;
      }
      .lock-button:hover {
        background-color: #555;
      }
      /* Game Bar Styles */
      #gamebar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #222;
        z-index: 15000;
        padding: 5px 10px;
        display: flex;
        align-items: center;
      }
      /* Layout: Left arrow, App launcher, Right arrow, then clock/battery, then Widgets menu button */
      #gm-left, #gm-right {
        background-color: #444;
        border: none;
        color: #e0e0e0;
        font-size: 24px;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
      }
      #gm-left:hover, #gm-right:hover {
        background-color: #555;
      }
      #gm-launcher {
        margin: 0 10px;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
      }
      #gm-launcher img {
        width: 24px;
        height: 24px;
        margin-right: 5px;
      }
      #gm-clock-battery {
        margin: 0 10px;
        font-size: 16px;
      }
      #gm-widgets-menu {
        background-color: #444;
        border: none;
        color: #e0e0e0;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 16px;
      }
      #gm-widgets-menu:hover {
        background-color: #555;
      }
      /* Widgets container */
      #widgets-container {
        position: fixed;
        bottom: 50px;
        right: 20px;
        background-color: rgba(0,0,0,0.8);
        padding: 10px;
        border-radius: 4px;
        z-index: 16000;
        display: none;
      }
      .widget {
        background-color: #333;
        padding: 10px;
        margin: 5px;
        border-radius: 4px;
        cursor: move;
      }
      .widget iframe {
        width: 300px;
        height: 80px;
        border: none;
      }
      .widget.clock-widget {
        font-size: 24px;
        text-align: center;
      }
      /* Responsive adjustments */
      @media (max-width: 600px) {
        .desktop-app img {
          width: 48px;
          height: 48px;
        }
        #settings-sidebar {
          width: 200px;
          padding: 15px;
        }
        #settings-content {
          padding: 20px;
        }
        .setup-step {
          max-width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <script>
      // Clear sessionStorage on load.
      document.addEventListener("DOMContentLoaded", () => {
        sessionStorage.removeItem("loggedIn");
      });
      
      // Global variables.
      let installedApps = [];
      let openApps = [];
      // Game Mode variables.
      let gameModeOn = false;
      let gmApps = [];
      let gmCurrentIndex = 0;
      let gamepadInterval = null;
      
      // Widgets
      let widgetsMenuOpen = false;
      
      function loadInstalledApps() {
        return new Promise((resolve) => {
          if (localStorage.getItem("installedApps")) {
            installedApps = JSON.parse(localStorage.getItem("installedApps"));
          } else {
            installedApps = [];
          }
          resolve();
        });
      }
      
      function saveOSTheme(osName) {
        localStorage.setItem("osTheme", osName);
      }
      
      function changeOS(osName) {
        saveOSTheme(osName);
        const stylesheet = document.querySelector('link[rel="stylesheet"]');
        const startBtn = document.getElementById("start-button");
        if (!stylesheet || !startBtn) return;
        if (osName === "default") {
          stylesheet.href = "assets/css/default.css";
          startBtn.innerHTML = "❖";
        } else {
          stylesheet.href = "assets/css/" + osName + ".css";
          startBtn.innerHTML = `<img src="images/icons/${osName}/start.png" alt="Start">`;
        }
      }
      
      function restoreOSTheme() {
        const savedOS = localStorage.getItem("osTheme");
        if (savedOS) {
          changeOS(savedOS);
        }
      }
      
      function installJstoreIfNotInstalled() {
        const jstoreInstalled = installedApps.some(app => app.name === "Jstore");
        if (!jstoreInstalled) {
          installApp("Jstore", "apps/icons/jstore.png", "");
          const jstoreApp = installedApps.find(app => app.name === "Jstore");
          if (jstoreApp) {
            jstoreApp.htmlContent = `
              <div id="jstore-container">
                <h1>Jstore</h1>
                <input type="text" id="jstore-search" placeholder="Search apps..." oninput="filterJstoreApps(this.value)">
                <div id="jstore-app-list"></div>
              </div>
            `;
            localStorage.setItem("installedApps", JSON.stringify(installedApps));
          }
        }
      }
      
      function installSettingsIfNotInstalled() {
        const settingsInstalled = installedApps.some(app => app.name === "Settings");
        if (!settingsInstalled) {
          installApp("Settings", "apps/icons/settings.png", "");
          const settingsApp = installedApps.find(app => app.name === "Settings");
          if (settingsApp) {
            settingsApp.htmlContent = `
              <div id="settings-app">
                <div id="settings-sidebar">
                  <input type="text" id="settings-search" placeholder="Search settings..." />
                  <ul id="settings-options">
                    <li data-tab="personalization">
                      <img src="https://jxoj.github.io/Jxo-OS/images/icons/settings/sidebar/personalization.webp" alt="Personalization" />
                      <span>Personalization</span>
                    </li>
                    <li data-tab="account">
                      <img src="https://jxoj.github.io/Jxo-OS/images/icons/settings/sidebar/account.webp" alt="Account" />
                      <span>Account</span>
                    </li>
                  </ul>
                </div>
                <div id="settings-content"></div>
              </div>
            `;
            localStorage.setItem("installedApps", JSON.stringify(installedApps));
          }
        }
      }
      
      function loadJstoreApps() {
        fetch("https://jxoj.github.io/Jxo-OS/apps/apps.json")
          .then(response => {
            if (!response.ok) throw new Error("Network error");
            return response.json();
          })
          .then(apps => {
            const list = document.getElementById("jstore-app-list");
            if (!list) return;
            list.innerHTML = "";
            apps.forEach(app => {
              const isInstalled = installedApps.some(a => a.name === app.name);
              const button = document.createElement("button");
              button.dataset.icon = app.icon;
              button.dataset.url = app.url;
              button.textContent = isInstalled ? "Uninstall" : "Install";
              button.onclick = isInstalled 
                ? () => uninstallJstoreApp(app.name, button)
                : () => installJstoreApp(app.name, app.icon, app.url, button);
              const appDiv = document.createElement("div");
              appDiv.classList.add("jstore-app-item");
              appDiv.innerHTML = `<img src="${app.icon}" alt="${app.name} icon"><span style="flex-grow:1;">${app.name}</span>`;
              appDiv.appendChild(button);
              list.appendChild(appDiv);
            });
          })
          .catch(error => {
            console.error("Failed to load Jstore apps:", error);
            const list = document.getElementById("jstore-app-list");
            if (list) list.innerHTML = "<p>Error loading apps.</p>";
          });
      }
      
      function installJstoreApp(name, icon, url, button) {
        installApp(name, icon, url);
        button.textContent = "Uninstall";
        button.onclick = () => uninstallJstoreApp(name, button);
      }
      
      function uninstallJstoreApp(name, button) {
        uninstallApp(name);
        button.textContent = "Install";
        button.onclick = () => installJstoreApp(name, button.dataset.icon, button.dataset.url, button);
      }
      
      function filterJstoreApps(query) {
        const apps = document.querySelectorAll(".jstore-app-item");
        apps.forEach(app => {
          const name = app.querySelector("span").textContent.toLowerCase();
          app.style.display = name.includes(query.toLowerCase()) ? "flex" : "none";
        });
      }
      
      function installApp(name, image, iframeUrl) {
        const newApp = {
          name: name,
          appId: name.toLowerCase().replace(/\s+/g, ""),
          image: image,
          htmlUrl: iframeUrl,
        };
        installedApps.push(newApp);
        localStorage.setItem("installedApps", JSON.stringify(installedApps));
        renderDesktop();
      }
      
      function uninstallApp(appName) {
        installedApps = installedApps.filter(app => app.name.toLowerCase() !== appName.toLowerCase());
        localStorage.setItem("installedApps", JSON.stringify(installedApps));
        renderDesktop();
      }
      
      function initSettingsApp() {
        const searchInput = document.getElementById("settings-search");
        const optionsList = document.getElementById("settings-options");
        if (searchInput && optionsList) {
          searchInput.addEventListener("input", function () {
            const query = searchInput.value.toLowerCase();
            Array.from(optionsList.getElementsByTagName("li")).forEach(li => {
              li.style.display = li.textContent.toLowerCase().includes(query) ? "" : "none";
            });
          });
        }
        const sidebarItems = document.querySelectorAll("#settings-options li");
        sidebarItems.forEach(item => {
          item.addEventListener("click", function () {
            sidebarItems.forEach(i => i.classList.remove("active"));
            item.classList.add("active");
            const tab = item.getAttribute("data-tab");
            if (tab === "personalization") {
              loadPersonalizationTab();
            } else if (tab === "account") {
              loadAccountTab();
            }
          });
        });
        loadPersonalizationTab();
      }
      
      function loadPersonalizationTab() {
        const content = document.getElementById("settings-content");
        if (!content) return;
        const wallpapers = [];
        for (let i = 1; i <= 41; i++) {
          wallpapers.push("wallpaper" + i);
        }
        const osOptions = ["default", "windows10"];
        content.innerHTML = `
          <h2>Personalization</h2>
          <div style="margin-bottom:20px;">
            <h3>Change OS Theme</h3>
            <select id="os-dropdown">
              ${osOptions.map(os => `<option value="${os}">${os}</option>`).join("")}
            </select>
          </div>
          <div style="margin-bottom:20px;">
            <h3>Change Background Image</h3>
            <div id="bg-preview-container">
              <img id="bg-preview" src="images/backgrounds/wallpaper1.jpg" alt="Background Preview" />
            </div>
            <select id="wallpaper-dropdown">
              ${wallpapers.map(wp => `<option value="images/backgrounds/${wp}.jpg">${wp}.jpg</option>`).join("")}
            </select>
          </div>
          <div style="margin-bottom:20px;">
            <h3>Change Background Color</h3>
            <input type="color" id="bg-color-picker" />
          </div>
          <div style="margin-bottom:20px;">
            <h3>Toggle Light/Dark Mode</h3>
            <select id="mode-toggle">
              <option value="dark">Dark Mode</option>
              <option value="light">Light Mode</option>
            </select>
          </div>
        `;
        const osDropdown = document.getElementById("os-dropdown");
        osDropdown.value = localStorage.getItem("osTheme") || "default";
        osDropdown.addEventListener("change", function () {
          changeOS(osDropdown.value);
        });
        const wallpaperDropdown = document.getElementById("wallpaper-dropdown");
        const bgPreview = document.getElementById("bg-preview");
        if (wallpaperDropdown && bgPreview) {
          wallpaperDropdown.value = "images/backgrounds/wallpaper1.jpg";
          bgPreview.src = wallpaperDropdown.value;
          wallpaperDropdown.addEventListener("change", function () {
            const selected = wallpaperDropdown.value;
            bgPreview.src = selected;
            changeBackgroundimage(selected);
          });
        }
        const colorPicker = document.getElementById("bg-color-picker");
        colorPicker.addEventListener("input", function () {
          const hex = colorPicker.value;
          const r = parseInt(hex.substr(1, 2), 16);
          const g = parseInt(hex.substr(3, 2), 16);
          const b = parseInt(hex.substr(5, 2), 16);
          changeBackground(r, g, b);
        });
        const modeToggle = document.getElementById("mode-toggle");
        modeToggle.value = localStorage.getItem("mode") || "dark";
        modeToggle.addEventListener("change", function () {
          toggleLightDark(modeToggle.value);
        });
        toggleLightDark(modeToggle.value);
      }
      
      function loadAccountTab() {
        const content = document.getElementById("settings-content");
        if (!content) return;
        content.innerHTML = `
          <h2>Account</h2>
          <div style="background:#333; padding:20px; border-radius:8px; max-width:400px;">
            <div style="margin-bottom:10px;">
              <label style="display:block; margin-bottom:5px;">New Username:</label>
              <input type="text" id="new-username" placeholder="Enter new username" />
            </div>
            <div style="margin-bottom:10px;">
              <label style="display:block; margin-bottom:5px;">New Password:</label>
              <input type="password" id="new-password" placeholder="Enter new password">
              <button class="toggle-password" onclick="toggleInputPassword('new-password', this)">
                <img src="images/icons/setup/show.png" alt="Show">
              </button>
            </div>
            <button onclick="updateAccount(document.getElementById('new-username').value,document.getElementById('new-password').value)" style="padding:10px 20px; background:#555; border:none; border-radius:4px; cursor:pointer; color:#e0e0e0;">Update Account</button>
            <div id="account-message" style="margin-top:10px;"></div>
          </div>
        `;
      }
      
      function toggleInputPassword(id, btn) {
        const input = document.getElementById(id);
        if (input.type === "password") {
          input.type = "text";
          if (btn) btn.innerHTML = `<img src="images/icons/setup/hide.png" alt="Hide" />`;
        } else {
          input.type = "password";
          if (btn) btn.innerHTML = `<img src="images/icons/setup/show.png" alt="Show" />`;
        }
      }
      
      function changePassword(newPassword) {
        localStorage.setItem("password", newPassword);
      }
      
      function updateAccount(newUsername, newPassword) {
        localStorage.setItem("username", newUsername);
        changePassword(newPassword);
        const msg = document.getElementById("account-message");
        if (msg) msg.innerText = "Account updated successfully!";
      }
      
      function showPasswordModal() {
        let modal = document.createElement("div");
        modal.classList.add("password-modal");
        let profilePic = localStorage.getItem("profilePic") || "images/icons/profile/profile.png";
        if (localStorage.getItem("password")) {
          let usernameField = localStorage.getItem("username")
            ? `<p>Welcome, ${localStorage.getItem("username")}!</p>`
            : `<input type="text" id="username-input" placeholder="Enter your username">`;
          modal.innerHTML = `
            <div class="password-modal-content">
              <img src="${profilePic}" alt="Profile Icon">
              ${usernameField}
              <h3>Enter Password</h3>
              <div style="display:inline-flex; align-items:center;">
                <input type="password" id="entered-password" placeholder="Enter password">
                <button class="toggle-password" onclick="toggleInputPassword('entered-password', this)">
                  <img src="images/icons/setup/show.png" alt="Show">
                </button>
              </div>
              <br>
              <button onclick="checkPassword()">Enter</button>
            </div>
          `;
        } else {
          modal.innerHTML = `
            <div class="password-modal-content">
              <img src="${profilePic}" alt="Profile Icon">
              <h3>Set up your account</h3>
              <input type="text" id="username-input" placeholder="Enter your username">
              <br>
              <input type="password" id="new-password" placeholder="Enter new password">
              <br>
              <button onclick="setCredentials()">Set Credentials</button>
            </div>
          `;
        }
        document.body.appendChild(modal);
      }
      
      function checkPassword() {
        const entered = document.getElementById("entered-password").value;
        const stored = localStorage.getItem("password");
        if (entered === stored) {
          document.querySelector(".password-modal").remove();
        } else {
          alert("Incorrect password!");
        }
      }
      
      function setCredentials() {
        const username = document.getElementById("username-input").value;
        const newPass = document.getElementById("new-password").value;
        if (username && newPass) {
          localStorage.setItem("username", username);
          localStorage.setItem("password", newPass);
          document.querySelector(".password-modal").remove();
        } else {
          alert("Username and password cannot be empty!");
        }
      }
      
      function changeUsername(newUsername) {
        localStorage.setItem("username", newUsername);
      }
      
      function toggleLightDark(mode) {
        localStorage.setItem("mode", mode);
        const storedBackground = localStorage.getItem("background");
        if (mode === "light") {
          document.body.style.color = "#000000";
          if (storedBackground) {
            document.body.style.background = storedBackground;
          } else {
            document.body.style.backgroundColor = "#f0f0f0";
          }
          const taskbar = document.getElementById("taskbar");
          if (taskbar) taskbar.style.backgroundColor = "#e0e0e0";
        } else {
          document.body.style.color = "#e0e0e0";
          if (storedBackground) {
            document.body.style.background = storedBackground;
          } else {
            document.body.style.backgroundColor = "#121212";
          }
          const task
