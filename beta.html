<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="images/icons/favicon.png" type="image/png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jxo OS</title>
    <link rel="stylesheet" href="assets/css/default.css" />
    <style>
      /* Dark Theme Base */
      body { background-color: #121212; color: #e0e0e0; font-family: Arial, sans-serif; margin: 0; }
      .taskbar { background-color: #1f1f1f; border-top: 1px solid #333; }
      /* Mobile Fullscreen App */
      .fullscreen-mobile { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; border: none; z-index: 10000; }
      /* Mobile menu toggle arrow */
      #mobile-menu-toggle { display: none; position: fixed; bottom: 10px; right: 10px; font-size: 2rem; z-index: 10001; background: #333; color: white; border-radius: 50%; padding: 10px; cursor: pointer; }
      /* Mobile full-screen app search menu */
      #mobile-app-menu { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #2a2a2a; z-index: 10002; overflow: auto; padding: 20px; box-sizing: border-box; }
      #mobile-app-menu .close-btn { position: absolute; top: 10px; right: 10px; font-size: 1.5rem; cursor: pointer; color: #e0e0e0; }
      .app-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #444; cursor: pointer; color: #e0e0e0; }
      .app-item img { width: 32px; height: 32px; margin-right: 10px; }
      @media (max-width: 600px) { .desktop-app img { width: 48px; height: 48px; } }
    </style>
  </head>
  <body>
    <script>
      // Mobile detection
      function isMobile() { return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent); }
      // App storage
      let installedApps = [], openApps = [];
      document.addEventListener("DOMContentLoaded", () => {
        loadInstalledApps().then(() => {
          loadBackground();
          if (!localStorage.getItem("setupComplete")) showSetupScreen();
          else showBootScreen();
        });
      });
      // Load/install utilities
      function loadInstalledApps() {
        return new Promise(resolve => {
          installedApps = JSON.parse(localStorage.getItem('installedApps')||'[]'); resolve();
        });
      }
      function saveInstalled() { localStorage.setItem('installedApps', JSON.stringify(installedApps)); }
      function saveOSTheme(os){ localStorage.setItem('osTheme',os); }
      function changeOS(os){ saveOSTheme(os); const ss=document.querySelector('link[rel=stylesheet]'),btn=document.getElementById('start-button'); if(os==='default'){ ss.href='assets/css/default.css'; btn.innerHTML='❖'; }else{ ss.href=`assets/css/${os}.css`; btn.innerHTML=`<img src="images/icons/${os}/start.png" alt="Start">`; }}
      function restoreOSTheme(){ const s=localStorage.getItem('osTheme'); if(s) changeOS(s); }
      // Jstore & Settings installers
      function installJstoreIfNotInstalled(){ if(!installedApps.find(a=>a.name==='Jstore')) installApp('Jstore','apps/icons/jstore.png',''); }
      function installSettingsIfNotInstalled(){ if(!installedApps.find(a=>a.name==='Settings')) installApp('Settings','apps/icons/settings.png',''); }
      // Fetch apps for Jstore
      function loadJstoreApps(){ fetch('https://jxoj.github.io/Jxo-OS/apps/apps.json')
        .then(r=>r.json()).then(apps=>{ const list=document.getElementById('jstore-app-list'); list.innerHTML=''; apps.forEach(app=>{ const isInst=installedApps.find(a=>a.name===app.name); const btn=document.createElement('button'); btn.dataset.icon=app.icon; btn.dataset.url=app.url; btn.textContent=isInst?'Uninstall':'Install'; btn.onclick=()=>{ isInst?uninstallJstoreApp(app.name,btn):installJstoreApp(app.name,app.icon,app.url,btn); }; const div=document.createElement('div'); div.className='jstore-app-item'; div.innerHTML=`<img src="${app.icon}"><span>${app.name}</span>`; div.appendChild(btn); list.appendChild(div); }); }); }
      function installJstoreApp(n,i,u,btn){ installApp(n,i,u); btn.textContent='Uninstall'; btn.onclick=()=>uninstallJstoreApp(n,btn); }
      function uninstallJstoreApp(n,btn){ uninstallApp(n); btn.textContent='Install'; btn.onclick=()=>installJstoreApp(n,btn.dataset.icon,btn.dataset.url,btn); }
      function filterJstoreApps(q){ document.querySelectorAll('.jstore-app-item').forEach(el=>{ el.style.display=el.textContent.toLowerCase().includes(q.toLowerCase())?'flex':'none'; }); }
      // App install/uninstall
      function installApp(name,img,url){ installedApps.push({name,appId:name.toLowerCase(),image:img,htmlUrl:url,htmlContent:''}); saveInstalled(); renderDesktop(); }
      function uninstallApp(name){ installedApps=installedApps.filter(a=>a.name!==name); saveInstalled(); renderDesktop(); }
      // Settings app init
      function initSettingsApp(){ const search=document.getElementById('settings-search'),opts=document.getElementById('settings-options'); search&&(search.oninput=e=>{Array.from(opts.children).forEach(li=>li.style.display=li.textContent.toLowerCase().includes(e.target.value.toLowerCase())?'':'none');}); opts&&Array.from(opts.children).forEach(li=>li.onclick=function(){opts.querySelector('.active')?.classList.remove('active');li.classList.add('active'); this.getAttribute('data-tab')==='personalization'?loadPersonalizationTab():loadAccountTab();}); loadPersonalizationTab(); }
      function loadPersonalizationTab(){ const c=document.getElementById('settings-content'); if(!c)return; const wps=Array.from({length:41},(_,i)=>`wallpaper${i+1}`); const oss=['default','windows10']; c.innerHTML=`<h2>Personalization</h2><h3>OS Theme</h3><select id="os-dropdown">${oss.map(o=>`<option value="${o}">${o}</option>`).join('')}</select><h3>Background</h3><div id="bg-preview-container"><img id="bg-preview" src="images/backgrounds/wallpaper1.jpg"></div><select id="wallpaper-dropdown">${wps.map(w=>`<option value="images/backgrounds/${w}.jpg">${w}.jpg</option>`).join('')}</select><h3>Bg Color</h3><input type="color" id="bg-color-picker"><h3>Mode</h3><select id="mode-toggle"><option value="dark">Dark</option><option value="light">Light</option></select>`; const od=document.getElementById('os-dropdown'); od.value=localStorage.getItem('osTheme')||'default'; od.onchange=()=>changeOS(od.value); const wd=document.getElementById('wallpaper-dropdown'),bp=document.getElementById('bg-preview'); wd.onchange=e=>{bp.src=e.target.value; changeBackgroundimage(e.target.value);} ;document.getElementById('bg-color-picker').oninput=e=>{const hex=e.target.value,r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16); changeBackground(r,g,b);}; const mt=document.getElementById('mode-toggle'); mt.value=localStorage.getItem('mode')||'dark'; mt.onchange=e=>toggleLightDark(e.target.value); toggleLightDark(mt.value);}      
      function loadAccountTab(){ const c=document.getElementById('settings-content'); if(!c)return; c.innerHTML=`<h2>Account</h2><label>Username:</label><input id="new-username"><label>Password:</label><div style="display:flex"><input type="password" id="new-password"><button class="toggle-password" onclick="toggleInputPassword('new-password',this)"><img src="images/icons/setup/show.png"></button></div><button onclick="updateAccount(document.getElementById('new-username').value,document.getElementById('new-password').value)">Update</button><div id="account-message"></div>`; }
      function toggleInputPassword(id,btn){ const inp=document.getElementById(id); inp.type=inp.type==='password'?'text':'password'; btn.innerHTML=`<img src="images/icons/setup/${inp.type==='password'?'show':'hide'}.png">`; }
      function updateAccount(u,p){ localStorage.setItem('username',u); localStorage.setItem('password',p); document.getElementById('account-message').innerText='Updated'; }
      // Background & mode
      function loadBackground(){ const bg=localStorage.getItem('background'); if(bg)document.body.style.background=bg; }
      function changeBackground(r,g,b){ const c=`rgb(${r},${g},${b})`; document.body.style.background=c; localStorage.setItem('background',c); }
      function changeBackgroundimage(url){ const v=`url(${url}) center/cover fixed`; document.body.style.background=v; localStorage.setItem('background',v); }
      function toggleLightDark(m){ localStorage.setItem('mode',m); if(m==='light'){ document.body.style.color='#000'; document.body.style.backgroundColor='#f0f0f0'; document.getElementById('taskbar').style.background='#e0e0e0'; }else{ document.body.style.color='#e0e0e0'; document.body.style.backgroundColor='#121212'; document.getElementById('taskbar').style.background='#1f1f1f'; }}
      // Boot & setup
      function showBootScreen(){ document.body.innerHTML=`<div class="boot-screen"><span class="boot-title" style="font-size:4em;">Jx</span></div>`; setTimeout(()=>{ loadOS(); localStorage.getItem('setupComplete')?setTimeout(showPasswordModal,500):null; },2000);}      
      function showSetupScreen(){ /* Multi-step setup as original code */ /* For brevity, use original implementation... */ showBootScreen(); }
      function showPasswordModal(){ /* Original modal code */ }
      // Render desktop & windows
      function renderDesktop(){ const d=document.getElementById('desktop'); d.innerHTML=''; installedApps.forEach(a=>{ const s=document.createElement('div'); s.className='desktop-app'; s.innerHTML=`<img src="${a.image}"><span>${a.name}</span>`; s.onclick=()=>openAppWindow(a.appId); d.appendChild(s); }); }
      function updateTaskbar(){ const o=document.getElementById('open-apps'); o.innerHTML=''; openApps.forEach(id=>{ const a=installedApps.find(x=>x.appId===id); if(a){ const img=document.createElement('img'); img.src=a.image; img.onclick=()=>bringToFront(id); o.appendChild(img);} }); }
      function bringToFront(id){ const w=document.getElementById(id); w&&document.body.appendChild(w); }
      function closeWindow(id){ document.getElementById(id).remove(); openApps=openApps.filter(x=>x!==id); updateTaskbar(); }
      function toggleFullscreen(id){ const el=document.getElementById(id); if(el.style.position==='fixed'){ el.style.position='absolute'; el.style.width='600px'; el.style.height='400px'; el.classList.remove('fullscreen-mobile'); } else { el.style.position='fixed'; el.style.top='0'; el.style.left='0'; el.style.width='100vw'; el.style.height='100vh'; el.classList.add('fullscreen-mobile'); } }
      function makeDraggable(w){ /* original drag logic */ }
      function makeResizable(w){ /* original resize logic */ }
      function updateClock(){ const n=new Date(); document.getElementById('clock').innerText=n.toLocaleTimeString(); document.getElementById('date').innerText=n.toLocaleDateString(); }
      function toggleSearchMenu(){ const m=document.getElementById('search-menu'); m.style.display=m.style.display==='block'?'none':'block'; if(m.style.display==='block') filterApps(''); }
      function filterApps(q){ const l=document.getElementById('app-list'); l.innerHTML=''; installedApps.filter(a=>!q||a.name.toLowerCase().includes(q.toLowerCase())).sort((a,b)=>a.name.localeCompare(b.name)).forEach(a=>{ const div=document.createElement('div'); div.className='app-item'; div.innerHTML=`<img src="${a.image}"><span>${a.name}</span>`; div.onclick=()=>openAppWindow(a.appId); l.appendChild(div); }); }
      function powerOff(){ document.body.innerHTML='<div class="shutdown-screen"><h2>Shutting down...</h2></div>'; }
      // Mobile menu
      function toggleMobileMenu(){ const m=document.getElementById('mobile-app-menu'); if(m.style.display==='block') m.style.display='none'; else{ renderMobileAppList(); m.style.display='block'; }}
      function renderMobileAppList(){ const m=document.getElementById('mobile-app-menu'); m.innerHTML='<span class="close-btn" onclick="toggleMobileMenu()">✕</span>'; installedApps.sort((a,b)=>a.name.localeCompare(b.name)).forEach(a=>{ const it=document.createElement('div'); it.className='app-item'; it.innerHTML=`<img src="${a.image}"><span>${a.name}</span>`; it.onclick=()=>{toggleMobileMenu(); openAppWindow(a.appId);} ; m.appendChild(it); }); }
      function loadOS(){ document.body.innerHTML=`<div id="desktop"></div><div id="taskbar" class="taskbar"><button id="start-button" onclick="toggleSearchMenu()">❖</button><div id="open-apps"></div><div id="taskbar-right"><span id="date"></span><span id="clock"></span><button onclick="showPasswordModal()">Lock</button><button onclick="powerOff()">Power Down</button></div></div><div id="search-menu" style="display:none;"><span class="close-btn" onclick="toggleSearchMenu()">✕</span><input oninput="filterApps(this.value)"><div id="app-list"></div></div><div id="mobile-menu-toggle" onclick="toggleMobileMenu()">⬆️</div><div id="mobile-app-menu"></div>`;
        installJstoreIfNotInstalled(); installSettingsIfNotInstalled(); renderDesktop(); updateTaskbar(); restoreOSTheme(); setInterval(updateClock,1000);
        if(isMobile()){ document.getElementById('taskbar').style.display='none'; document.getElementById('mobile-menu-toggle').style.display='block'; }
      }
    </script>
  </body>
</html>
