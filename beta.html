<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="images/icons/favicon.png" type="image/png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jxo OS</title>
    <link rel="stylesheet" href="assets/css/default.css" />
    <style>
      /* Dark Theme Base */
      body {
        background-color: #121212;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        margin: 0;
      }
      .taskbar {
        background-color: #1f1f1f;
        border-top: 1px solid #333;
      }
      /* Mobile Fullscreen App */
      .fullscreen-mobile {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        border: none;
        z-index: 10000;
      }
      /* Mobile menu toggle arrow */
      #mobile-menu-toggle {
        display: none;
        position: fixed;
        bottom: 10px;
        right: 10px;
        font-size: 2rem;
        z-index: 10001;
        background: #333;
        color: white;
        border-radius: 50%;
        padding: 10px;
        cursor: pointer;
      }
      /* Mobile full-screen app search menu */
      #mobile-app-menu {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: #2a2a2a;
        z-index: 10002;
        overflow: auto;
        padding: 20px;
        box-sizing: border-box;
      }
      #mobile-app-menu .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 1.5rem;
        cursor: pointer;
      }
      .app-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #444;
        cursor: pointer;
      }
      .app-item img {
        width: 32px;
        height: 32px;
        margin-right: 10px;
      }
      /* Responsive adjustments for phones */
      @media (max-width: 600px) {
        .desktop-app img {
          width: 48px;
          height: 48px;
        }
      }
    </style>
  </head>
  <body>
    <script>
      // Utility: detect mobile
      function isMobile() {
        return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
      }

      // Global variables for installed and open apps.
      let installedApps = [];
      let openApps = [];

      // [existing functions like loadInstalledApps, saveOSTheme, changeOS, restoreOSTheme, installJstoreIfNotInstalled, installSettingsIfNotInstalled, loadJstoreApps, installJstoreApp, uninstallJstoreApp, filterJstoreApps, installApp, uninstallApp, initSettingsApp, loadPersonalizationTab, loadAccountTab, toggleInputPassword, changePassword, updateAccount, showPasswordModal, checkPassword, setCredentials, changeUsername, toggleLightDark, showBootScreen, loadBackground, saveBackground, changeBackground, changeBackgroundimage, renderDesktop skipped for brevity]

      // Open app window.
      function openAppWindow(appId) {
        const app = installedApps.find((a) => a.appId === appId);
        if (app && !document.getElementById(appId)) {
          const appWindow = document.createElement("div");
          appWindow.classList.add("app-window");
          appWindow.id = appId;
          appWindow.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close" />
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen" />
                </button>
              </div>
            </div>
            <div class="window-content">
              ${app.htmlContent || `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(appWindow);
          makeDraggable(appWindow);
          makeResizable(appWindow);
          openApps.push(appId);
          updateTaskbar();
          // Auto-fullscreen on mobile
          if (isMobile()) {
            toggleFullscreen(appId);
          }
          // Init app-specific logic
          if (appId === "jstore") setTimeout(loadJstoreApps, 100);
          if (appId === "settings") setTimeout(initSettingsApp, 100);
        }
      }

      // Toggle fullscreen updated for mobile
      function toggleFullscreen(appId) {
        const el = document.getElementById(appId);
        if (!el) return;
        if (el.classList.contains('fullscreen-mobile')) {
          el.classList.remove('fullscreen-mobile');
          el.style.position = 'absolute';
          el.style.width = '600px';
          el.style.height = '400px';
        } else {
          el.classList.add('fullscreen-mobile');
        }
      }

      // Toggle mobile menu
      function toggleMobileMenu() {
        const menu = document.getElementById('mobile-app-menu');
        if (menu.style.display === 'block') {
          menu.style.display = 'none';
        } else {
          renderMobileAppList();
          menu.style.display = 'block';
        }
      }

      // Render mobile app list
      function renderMobileAppList() {
        const list = document.getElementById('mobile-app-menu');
        // clear existing items except close button
        list.innerHTML = `<span class="close-btn" onclick="toggleMobileMenu()">✕</span>`;
        installedApps
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach(app => {
            const item = document.createElement('div');
            item.classList.add('app-item');
            item.innerHTML = `<img src="${app.image}" alt="${app.name}"><span>${app.name}</span>`;
            item.onclick = () => { toggleMobileMenu(); openAppWindow(app.appId); };
            list.appendChild(item);
          });
      }

      // Load OS
      function loadOS() {
        document.body.innerHTML = `
          <div id="desktop"></div>
          <div id="taskbar" class="taskbar">
            <button id="start-button" onclick="toggleSearchMenu()" class="taskbar-button search-btn">❖</button>
            <div id="open-apps"></div>
            <div id="taskbar-right">
              <div id="clock-container">
                <span id="date"></span>
                <span id="clock"></span>
              </div>
              <button class="lock-button" onclick="showPasswordModal()">Lock</button>
              <button onclick="powerOff()" class="power-button">Power Down</button>
            </div>
          </div>
          <div id="search-menu" class="search-menu" style="display:none;">
            <span class="close-btn" onclick="toggleSearchMenu()"><img src="images/icons/x.png" alt="Close"/></span>
            <input type="text" placeholder="Search apps..." oninput="filterApps(this.value)" />
            <div id="app-list"></div>
          </div>
          <div id="mobile-menu-toggle" onclick="toggleMobileMenu()">⬆️</div>
          <div id="mobile-app-menu"></div>
        `;
        installJstoreIfNotInstalled();
        installSettingsIfNotInstalled();
        renderDesktop();
        updateTaskbar();
        restoreOSTheme();
        setInterval(updateClock, 1000);
        // Show mobile controls
        if (isMobile()) {
          document.getElementById('taskbar').style.display = 'none';
          document.getElementById('mobile-menu-toggle').style.display = 'block';
        }
      }

      // Initial boot
      document.addEventListener("DOMContentLoaded", () => {
        loadInstalledApps().then(() => {
          loadBackground();
          if (!localStorage.getItem("setupComplete")) {
            showSetupScreen();
          } else {
            showBootScreen();
          }
        });
      });
    </script>
  </body>
</html>
