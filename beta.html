<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jxo OS</title>
  <!-- External stylesheet for additional styling if needed -->
  <link rel="stylesheet" href="assets/css/default.css" />
  <style>
    /* Base styles */
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    /* Taskbar */
    #taskbar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #1f1f1f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 10px;
      z-index: 1000;
    }
    /* Taskbar buttons */
    .taskbar-button {
      background: none;
      border: none;
      cursor: pointer;
    }
    #gameModeBtn img,
    #gm-button img,
    #start-button img {
      width: 24px;
      height: 24px;
      vertical-align: middle;
    }
    /* System menu button on taskbar */
    #systemMenuBtn {
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    #systemMenuBtn img {
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }
    /* System Menu */
    #systemMenu {
      position: fixed;
      bottom: 50px;
      right: 10px;
      background-color: #333;
      border: 1px solid #444;
      padding: 10px;
      z-index: 2000;
      display: none;
    }
    #systemMenu .menuItem {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      cursor: pointer;
    }
    #systemMenu .menuItem img {
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }
    #systemMenu .batteryInfo {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }
    #systemMenu .batteryInfo img {
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }
    /* Game Bar */
    #gameBar {
      position: fixed;
      top: 0;
      width: 100%;
      background-color: rgba(0,0,0,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 5px 10px;
      z-index: 1500;
    }
    #gameBar button {
      background-color: #444;
      border: none;
      color: #e0e0e0;
      font-size: 24px;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
      margin: 0 5px;
    }
    #gm-launcher {
      margin: 0 10px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
    }
    #gm-launcher img {
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }
    #clockWidget, #batteryWidget {
      margin-left: 20px;
      font-size: 18px;
    }
    /* Widgets Menu */
    #widgetsMenu {
      position: fixed;
      top: 50px;
      right: 10px;
      background-color: #333;
      border: 1px solid #444;
      padding: 10px;
      z-index: 2000;
      display: none;
    }
    #widgetsMenu .widget {
      background-color: #222;
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      color: #e0e0e0;
      cursor: move;
    }
    /* Desktop icons */
    .desktop-app {
      display: inline-block;
      margin: 10px;
      text-align: center;
    }
    .desktop-app img {
      width: 64px;
      height: 64px;
    }
    /* Setup Screen Styles */
    .setup-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #121212;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
      box-sizing: border-box;
    }
    .setup-step {
      max-width: 500px;
      width: 100%;
      text-align: center;
      margin-bottom: 20px;
    }
    .setup-step input, .setup-step select {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: inherit;
      color: inherit;
    }
    .setup-step button {
      padding: 10px 20px;
      background-color: #444;
      border: none;
      border-radius: 4px;
      color: #e0e0e0;
      cursor: pointer;
      margin: 5px;
    }
    .setup-step button:hover {
      background-color: #555;
    }
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      margin: 10px 0;
    }
    .file-input-wrapper input[type="file"] {
      opacity: 0;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-input-label {
      display: inline-block;
      padding: 10px 20px;
      background-color: #444;
      border-radius: 4px;
      cursor: pointer;
    }
    .preview-img {
      max-width: 100px;
      max-height: 100px;
      margin: 10px auto;
      display: block;
    }
    .toggle-password {
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      margin-left: 5px;
    }
    .toggle-password img {
      width: 16px;
      height: 16px;
      vertical-align: middle;
    }
    .lock-button {
      padding: 5px 10px;
      background-color: #444;
      border: none;
      border-radius: 4px;
      color: #e0e0e0;
      cursor: pointer;
      margin-right: 10px;
    }
    .lock-button:hover {
      background-color: #555;
    }
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .desktop-app img { width: 48px; height: 48px; }
      #taskbar { padding: 5px; }
      .setup-step { max-width: 90%; }
    }
  </style>
</head>
<body>
  <!-- Setup screen will be shown if not completed -->
  <div id="setupContainer"></div>

  <!-- Boot screen will be shown after setup -->
  <div id="bootScreen" class="hidden"></div>

  <!-- OS Desktop (populated after boot) -->
  <div id="desktop" class="hidden"></div>

  <!-- Taskbar -->
  <div id="taskbar" class="hidden">
    <button id="start-button" class="taskbar-button">‚ùñ</button>
    <button id="gm-button" class="taskbar-button" onclick="toggleGameBar()">
      <img id="gm-icon" src="images/icons/gm/off.png" alt="Game Mode">
    </button>
    <button id="systemMenuBtn" class="taskbar-button">
      <img src="images/icons/wifi.png" alt="WiFi">
      <img src="images/icons/battery.png" alt="Battery">
      <span id="batteryPercent">--%</span>
    </button>
    <div id="open-apps"></div>
    <div id="taskbar-right">
      <div id="clock-container">
        <span id="date"></span>
        <span id="clock"></span>
      </div>
      <button class="lock-button" onclick="showPasswordModal()">Lock</button>
      <button onclick="powerOff()">Power Down</button>
    </div>
  </div>

  <!-- System Menu -->
  <div id="systemMenu" class="hidden">
    <div class="menuItem">
      <img src="images/icons/minimenu/jfi.png" alt="Jfi">
      <span>Jfi</span>
    </div>
    <div class="menuItem">
      <img src="images/icons/minimenu/connect.png" alt="Connect">
      <span>Connect</span>
    </div>
    <div class="menuItem">
      <img src="images/icons/minimenu/brightness.png" alt="Brightness">
      <input type="range" id="brightnessSlider" min="0" max="100" value="50">
    </div>
    <div class="batteryInfo">
      <img src="images/icons/battery.png" alt="Battery">
      <span id="batteryPercentBottom">--%</span>
    </div>
  </div>

  <!-- Game Bar (hidden by default) -->
  <div id="gameBar" class="hidden">
    <button id="prevAppBtn" onclick="cycleApp(-1)">&#9664;</button>
    <div id="appDisplay" onclick="launchGMApp()"></div>
    <button id="nextAppBtn" onclick="cycleApp(1)">&#9654;</button>
    <div id="clockWidget"></div>
    <div id="batteryWidget"></div>
  </div>

  <!-- The following script contains all the core functionality -->
  <script>
    /* =======================
       Global Variables & Setup
    ========================== */
    let installedApps = [];
    let openApps = [];
    let setupComplete = localStorage.getItem("setupComplete") === "true";
    
    // For game bar navigation
    let gmApps = [];
    let gmCurrentIndex = 0;
    let gamepadInterval = null;
    
    /* =======================
       Setup & Boot Screen Functions
    ========================== */
    function showSetupScreen() {
      const setupContainer = document.getElementById("setupContainer");
      setupContainer.innerHTML = `
        <div class="setup-screen" id="setupScreen">
          <div class="setup-step" id="setupStep1">
            <h2>Let's get you setup</h2>
            <p>Please choose your username and password.</p>
            <input type="text" id="setup-username" placeholder="Username">
            <div>
              <input type="password" id="setup-password" placeholder="Password">
              <button class="toggle-password" onclick="toggleInputPassword('setup-password', this)">
                <img src="images/icons/setup/show.png" alt="Show">
              </button>
            </div>
            <button onclick="nextSetupStep(1)">Next</button>
          </div>
          <!-- Additional setup steps would follow (profile pic, wallpaper, theme, etc.) -->
          <!-- For brevity, assume setup is completed here -->
          <button onclick="completeSetup()">Complete Setup</button>
        </div>
      `;
    }
    function completeSetup() {
      // Save dummy setup data
      localStorage.setItem("username", "User");
      localStorage.setItem("password", "pass");
      localStorage.setItem("profilePic", "images/icons/profile/profile.png");
      localStorage.setItem("background", "images/backgrounds/wallpaper1.jpg");
      localStorage.setItem("osTheme", "default");
      localStorage.setItem("colorScheme", "dark");
      localStorage.setItem("setupComplete", "true");
      location.reload();
    }
    function showBootScreen() {
      document.getElementById("bootScreen").innerHTML = `
        <div class="boot-screen">
          <div class="boot-content">
            <span class="boot-title" style="font-size:4em;">Jx</span>
            <div class="loading-circle"></div>
          </div>
        </div>
      `;
      setTimeout(() => { loadOS(); }, 2000);
    }
    
    /* =======================
       OS & Desktop Functions
    ========================== */
    function loadOS() {
      document.getElementById("bootScreen").classList.add("hidden");
      document.getElementById("desktop").classList.remove("hidden");
      document.getElementById("taskbar").classList.remove("hidden");
      renderDesktop();
      updateTaskbar();
      restoreOSTheme();
      setInterval(updateClock, 1000);
      setInterval(updateSystemBattery, 60000);
    }
    function renderDesktop() {
      const desktop = document.getElementById("desktop");
      desktop.innerHTML = "";
      installedApps.forEach(app => {
        const shortcut = document.createElement("div");
        shortcut.classList.add("desktop-app");
        shortcut.innerHTML = `<img src="${app.image}" alt="${app.name} icon"><span>${app.name}</span>`;
        shortcut.onclick = () => openAppWindow(app.appId);
        desktop.appendChild(shortcut);
      });
    }
    function openAppWindow(appId) {
      const app = installedApps.find(app => app.appId === appId);
      if (app && !document.getElementById(appId)) {
        const win = document.createElement("div");
        win.classList.add("app-window");
        win.id = appId;
        win.innerHTML = `
          <div class="window-header">
            <span class="window-title">${app.name}</span>
            <div>
              <button class="window-btn" onclick="closeWindow('${appId}')">
                <img src="images/icons/x.png" alt="Close">
              </button>
              <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                <img src="images/icons/fullscreen.png" alt="Fullscreen">
              </button>
            </div>
          </div>
          <div class="window-content">
            ${app.htmlContent ? app.htmlContent : `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
          </div>
          <div class="resize-handle"></div>
        `;
        document.body.appendChild(win);
        makeDraggable(win);
        makeResizable(win);
        openApps.push(appId);
        updateTaskbar();
      }
    }
    function closeWindow(appId) {
      const win = document.getElementById(appId);
      if (win) { win.remove(); openApps = openApps.filter(id => id !== appId); updateTaskbar(); }
    }
    function updateTaskbar() {
      const container = document.getElementById("open-apps");
      container.innerHTML = "";
      openApps.forEach(appId => {
        const app = installedApps.find(app => app.appId === appId);
        if (app) {
          const img = document.createElement("img");
          img.src = app.image;
          img.alt = app.name;
          img.title = app.name;
          img.style.width = "32px";
          img.style.height = "32px";
          img.style.cursor = "pointer";
          img.onclick = () => bringToFront(appId);
          container.appendChild(img);
        }
      });
    }
    function bringToFront(appId) {
      const win = document.getElementById(appId);
      if (win) { document.body.appendChild(win); }
    }
    
    /* =======================
       Game Bar & Controller Functions
    ========================== */
    function toggleGameBar() {
      const gb = document.getElementById("gameBar");
      if (gb.classList.contains("hidden")) {
        gb.classList.remove("hidden");
        document.getElementById("gm-icon").src = "images/icons/gm/on.png";
        // Build game apps list from installedApps (excluding Settings and Jstore)
        gmApps = installedApps.filter(app => app.name !== "Settings" && app.name !== "Jstore");
        if (gmApps.length > 0) {
          gmCurrentIndex = Math.floor(Math.random() * gmApps.length);
          updateGMLauncher();
        }
        startGamepadPolling();
      } else {
        gb.classList.add("hidden");
        document.getElementById("gm-icon").src = "images/icons/gm/off.png";
        stopGamepadPolling();
      }
    }
    function updateGMLauncher() {
      const display = document.getElementById("appDisplay");
      if (gmApps.length === 0) { display.textContent = "No apps available"; return; }
      const app = gmApps[gmCurrentIndex];
      display.innerHTML = `<img src="${app.image}" alt="${app.name} icon">${app.name}`;
    }
    function cycleApp(direction) {
      if (gmApps.length === 0) return;
      gmCurrentIndex = (gmCurrentIndex + direction + gmApps.length) % gmApps.length;
      updateGMLauncher();
    }
    function launchGMApp() {
      if (gmApps.length === 0) return;
      const app = gmApps[gmCurrentIndex];
      if (app.htmlUrl) {
        let url = app.htmlUrl;
        url += (url.indexOf("?") === -1) ? "?controller=true" : "&controller=true";
        openAppWindowWithUrl(app.appId, url);
      } else {
        openAppWindow(app.appId);
      }
    }
    function openAppWindowWithUrl(appId, url) {
      const app = installedApps.find(app => app.appId === appId);
      if (app && !document.getElementById(appId)) {
        const win = document.createElement("div");
        win.classList.add("app-window");
        win.id = appId;
        win.innerHTML = `
          <div class="window-header">
            <span class="window-title">${app.name}</span>
            <div>
              <button class="window-btn" onclick="closeWindow('${appId}')">
                <img src="images/icons/x.png" alt="Close">
              </button>
              <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                <img src="images/icons/fullscreen.png" alt="Fullscreen">
              </button>
            </div>
          </div>
          <div class="window-content">
            <iframe src="${url}" width="100%" height="100%" style="border:none;"></iframe>
          </div>
          <div class="resize-handle"></div>
        `;
        document.body.appendChild(win);
        makeDraggable(win);
        makeResizable(win);
        openApps.push(appId);
        updateTaskbar();
      }
    }
    // Gamepad polling for digital buttons and analog stick
    function startGamepadPolling() {
      if (gamepadInterval) return;
      gamepadInterval = setInterval(() => {
        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        if (!gamepads) return;
        for (let gp of gamepads) {
          if (gp) {
            if (gp.buttons[14] && gp.buttons[14].pressed) { cycleApp(-1); }
            if (gp.buttons[15] && gp.buttons[15].pressed) { cycleApp(1); }
            if (gp.buttons[0] && gp.buttons[0].pressed) { launchGMApp(); }
            // Analog left stick X-axis
            let axis = gp.axes[0];
            if (axis < -0.5) { cycleApp(-1); }
            if (axis > 0.5) { cycleApp(1); }
          }
        }
      }, 100);
    }
    function stopGamepadPolling() {
      if (gamepadInterval) { clearInterval(gamepadInterval); gamepadInterval = null; }
    }
    
    /* =======================
       System Menu & Battery Functions
    ========================== */
    // Update battery info using the Battery Status API
    function updateSystemBattery() {
      const batteryPercentElem = document.getElementById("batteryPercent");
      const batteryPercentBottomElem = document.getElementById("batteryPercentBottom");
      if (navigator.getBattery) {
        navigator.getBattery().then(battery => {
          let level = Math.round(battery.level * 100) + "%";
          batteryPercentElem.textContent = level;
          batteryPercentBottomElem.textContent = level;
        });
      } else {
        batteryPercentElem.textContent = "N/A";
        batteryPercentBottomElem.textContent = "N/A";
      }
    }
    
    // Update game bar clock and battery widgets
    function updateGameBarWidgets() {
      const clockWidget = document.getElementById("clockWidget");
      const batteryWidget = document.getElementById("batteryWidget");
      let timeStr = new Date().toLocaleTimeString();
      if (navigator.getBattery) {
        navigator.getBattery().then(battery => {
          let level = Math.round(battery.level * 100) + "%";
          clockWidget.textContent = timeStr;
          batteryWidget.textContent = level;
        });
      } else {
        clockWidget.textContent = timeStr;
        batteryWidget.textContent = "N/A";
      }
    }
    setInterval(updateGameBarWidgets, 1000);
    
    /* =======================
       Widgets Menu (Placeholder)
    ========================== */
    function toggleWidgetsMenu() {
      const wm = document.getElementById("widgetsMenu");
      if (wm.classList.contains("hidden")) { wm.classList.remove("hidden"); }
      else { wm.classList.add("hidden"); }
    }
    function initWidgetsMenu() {
      if (!document.getElementById("widgetsMenu")) {
        const wm = document.createElement("div");
        wm.id = "widgetsMenu";
        wm.classList.add("hidden");
        wm.innerHTML = `
          <div class="widget" id="widget-spotify">Spotify Player (Placeholder)</div>
          <div class="widget" id="widget-clock">Clock Widget (Placeholder)</div>
        `;
        document.body.appendChild(wm);
        makeDraggable(wm);
      }
    }
    
    /* =======================
       Utility Functions (Draggable/Resizable)
    ========================== */
    function makeDraggable(el) {
      const header = el.querySelector(".window-header") || el;
      let isDragging = false, offsetX = 0, offsetY = 0;
      header.addEventListener("mousedown", e => { isDragging = true; offsetX = e.clientX - el.offsetLeft; offsetY = e.clientY - el.offsetTop; });
      el.addEventListener("mousemove", e => { if (isDragging) { el.style.left = `${e.clientX - offsetX}px`; el.style.top = `${e.clientY - offsetY}px`; } });
      el.addEventListener("mouseup", () => { isDragging = false; });
    }
    function makeResizable(el) {
      const handle = el.querySelector(".resize-handle");
      let isResizing = false, lastX, lastY;
      handle.addEventListener("mousedown", e => { isResizing = true; lastX = e.clientX; lastY = e.clientY; e.preventDefault(); });
      window.addEventListener("mousemove", e => { if (isResizing) { const dx = e.clientX - lastX, dy = e.clientY - lastY; el.style.width = el.offsetWidth + dx + "px"; el.style.height = el.offsetHeight + dy + "px"; lastX = e.clientX; lastY = e.clientY; } });
      window.addEventListener("mouseup", () => { isResizing = false; });
    }
    
    /* =======================
       Clock & Battery on Taskbar
    ========================== */
    function updateClock() {
      const now = new Date();
      document.getElementById("clock").textContent = now.toLocaleTimeString();
      document.getElementById("date").textContent = now.toLocaleDateString();
    }
    
    /* =======================
       Password Modal (Setup/Login)
    ========================== */
    function showPasswordModal() {
      let modal = document.createElement("div");
      modal.classList.add("password-modal");
      let profilePic = localStorage.getItem("profilePic") || "images/icons/profile/profile.png";
      if (localStorage.getItem("password")) {
        let usernameField = localStorage.getItem("username")
          ? `<p>Welcome, ${localStorage.getItem("username")}!</p>`
          : `<input type="text" id="username-input" placeholder="Enter your username">`;
        modal.innerHTML = `
          <div class="password-modal-content">
            <img src="${profilePic}" alt="Profile Icon">
            ${usernameField}
            <h3>Enter Password</h3>
            <div style="display:inline-flex; align-items:center;">
              <input type="password" id="entered-password" placeholder="Enter password">
              <button class="toggle-password" onclick="toggleInputPassword('entered-password', this)">
                <img src="images/icons/setup/show.png" alt="Show">
              </button>
            </div>
            <br>
            <button onclick="checkPassword()">Enter</button>
          </div>
        `;
      } else {
        modal.innerHTML = `
          <div class="password-modal-content">
            <img src="${profilePic}" alt="Profile Icon">
            <h3>Set up your account</h3>
            <input type="text" id="username-input" placeholder="Enter your username">
            <br>
            <input type="password" id="new-password" placeholder="Enter new password">
            <br>
            <button onclick="setCredentials()">Set Credentials</button>
          </div>
        `;
      }
      document.body.appendChild(modal);
    }
    function checkPassword() {
      const entered = document.getElementById("entered-password").value;
      const stored = localStorage.getItem("password");
      if (entered === stored) { document.querySelector(".password-modal").remove(); }
      else { alert("Incorrect password!"); }
    }
    function setCredentials() {
      const username = document.getElementById("username-input").value;
      const newPass = document.getElementById("new-password").value;
      if (username && newPass) {
        localStorage.setItem("username", username);
        localStorage.setItem("password", newPass);
        document.querySelector(".password-modal").remove();
      } else { alert("Username and password cannot be empty!"); }
    }
    function toggleInputPassword(id, btn) {
      const input = document.getElementById(id);
      if (input.type === "password") { input.type = "text"; btn.innerHTML = `<img src="images/icons/setup/hide.png" alt="Hide">`; }
      else { input.type = "password"; btn.innerHTML = `<img src="images/icons/setup/show.png" alt="Show">`; }
    }
    
    /* =======================
       Initialization
    ========================== */
    document.addEventListener("DOMContentLoaded", () => {
      if (!setupComplete) { showSetupScreen(); }
      else { showBootScreen(); }
      // Initialize installed apps (for demo, add a couple of apps)
      if (localStorage.getItem("installedApps") === null) {
        installedApps = [
          { name: "Jstore", appId: "jstore", image: "apps/icons/jstore.png", htmlUrl: "" },
          { name: "Settings", appId: "settings", image: "apps/icons/settings.png", htmlUrl: "" },
          { name: "Browser", appId: "browser", image: "apps/icons/browser.png", htmlUrl: "https://example.com" }
        ];
        localStorage.setItem("installedApps", JSON.stringify(installedApps));
      } else {
        installedApps = JSON.parse(localStorage.getItem("installedApps"));
      }
      
      // Update battery info on taskbar initially and then every minute
      updateSystemBattery();
      setInterval(updateSystemBattery, 60000);
      
      // Add event listener to system menu button
      document.getElementById("systemMenuBtn").addEventListener("click", () => {
        const sysMenu = document.getElementById("systemMenu");
        sysMenu.classList.toggle("hidden");
      });
      
      // Initialize Widgets Menu
      initWidgetsMenu();
      
      // Add event listener to brightness slider (handled in its own code block above)
    });
  </script>
</body>
</html>
