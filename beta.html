<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="icon" href="images/icons/favicon.png" type="image/png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jxo OS</title>
    <link rel="stylesheet" href="assets/css/default.css" />
    <style>
      /* Base styles */
      body {
        margin: 0;
        background-color: #121212;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
      }
      /* Taskbar remains unchanged by brightness changes */
      .taskbar {
        background-color: #1f1f1f;
        border-top: 1px solid #333;
        display: flex;
        align-items: center;
        padding: 0 10px;
      }
      /* OS Container: brightness filter applied here */
      #osContainer {
        filter: brightness(100%);
      }
      /* Desktop Icons */
      .desktop-app img {
        width: 64px;
        height: 64px;
      }
      /* Taskbar icons */
      #open-apps img {
        width: 32px;
        height: 32px;
      }
      #start-button img,
      #gm-button img {
        width: 24px;
        height: 24px;
      }
      /* Search Menu */
      #search-menu {
        background-color: #2a2a2a;
        padding: 10px;
        max-height: 70vh;
        overflow-y: auto;
      }
      #search-menu input[type="text"] {
        width: calc(100% - 20px);
        padding: 10px;
        margin-bottom: 10px;
        background-color: #333;
        border: none;
        border-radius: 5px;
        color: #e0e0e0;
        font-size: 16px;
      }
      #search-menu .close-btn {
        cursor: pointer;
      }
      #search-menu .close-btn img {
        width: 16px;
        height: 16px;
      }
      /* Mini Menu – dark background */
      #miniMenu {
        display: none;
        position: fixed;
        z-index: 21000;
        background-color: #000;
        padding: 10px;
        border: 1px solid #444;
        border-radius: 4px;
      }
      #miniMenu .menuItem {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        cursor: pointer;
      }
      #miniMenu .menuItem img {
        width: 32px;
        height: 32px;
        margin-right: 5px;
      }
      #miniMenu .batteryInfo {
        display: flex;
        align-items: center;
      }
      /* Brightness slider in mini menu */
      #brightnessSlider {
        margin-left: 5px;
      }
      /* Battery rectangle */
      #batteryContainer, #batteryContainerSys {
        width: 40px;
        height: 18px;
        border: 2px solid #fff;
        border-radius: 4px;
        background-color: #000;
        display: inline-block;
        vertical-align: middle;
        margin-right: 5px;
      }
      #batteryLevel, #batteryLevelSys {
        height: 100%;
        background-color: limegreen;
        transition: width 0.3s ease;
      }
      /* Game Bar */
      #gamebar {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #222;
        z-index: 15000;
        padding: 5px 10px;
        display: flex;
        align-items: center;
      }
      #gamebar button {
        background-color: #444;
        border: none;
        color: #e0e0e0;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 24px;
      }
      #gm-launcher {
        margin: 0 10px;
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 18px;
      }
      #gm-launcher img {
        width: 32px;
        height: 32px;
        margin-right: 5px;
      }
      #gm-clock {
        margin-left: 20px;
        font-size: 18px;
      }
      /* Widgets Menu (placeholder) */
      #widgets-menu {
        position: fixed;
        top: 50px;
        right: 10px;
        background-color: #333;
        border: 1px solid #444;
        padding: 10px;
        z-index: 2000;
        display: none;
      }
      #widgets-menu .widget {
        background-color: #222;
        border: 1px solid #444;
        padding: 10px;
        margin-bottom: 10px;
        color: #e0e0e0;
        cursor: move;
      }
      /* Jfi Connection Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 22000;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        background-color: #111;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 10px;
        color: white;
        box-shadow: 0 0 20px black;
      }
      .modal-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .modal input {
        padding: 8px;
        border: none;
        border-radius: 5px;
      }
      .modal button {
        padding: 8px;
        background-color: #444;
        color: white;
        border: none;
        border-radius: 5px;
      }
      .close {
        position: absolute;
        right: 10px;
        top: 5px;
        cursor: pointer;
        font-size: 20px;
      }
      /* Setup Screen */
      .setup-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: #121212;
        color: #e0e0e0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 20000;
        padding: 20px;
        box-sizing: border-box;
      }
      .setup-step {
        max-width: 500px;
        width: 100%;
        text-align: center;
        margin-bottom: 20px;
      }
      .setup-step input, .setup-step select {
        width: 90%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #444;
        border-radius: 4px;
        background-color: inherit;
        color: inherit;
      }
      .setup-step button {
        padding: 10px 20px;
        background-color: #444;
        border: none;
        border-radius: 4px;
        color: #e0e0e0;
        cursor: pointer;
        margin: 5px;
      }
      .setup-step button:hover {
        background-color: #555;
      }
      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin: 10px 0;
      }
      .file-input-wrapper input[type="file"] {
        opacity: 0;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }
      .file-input-label {
        display: inline-block;
        padding: 10px 20px;
        background-color: #444;
        border-radius: 4px;
        cursor: pointer;
      }
      .preview-img {
        max-width: 100px;
        max-height: 100px;
        margin: 10px auto;
        display: block;
      }
      /* Toggle Password Button */
      .toggle-password {
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        margin-left: 5px;
      }
      .toggle-password img {
        width: 16px;
        height: 16px;
        vertical-align: middle;
      }
      /* Lock Button */
      .lock-button {
        padding: 5px 10px;
        background-color: #444;
        border: none;
        border-radius: 4px;
        color: #e0e0e0;
        cursor: pointer;
        margin-right: 10px;
      }
      .lock-button:hover {
        background-color: #555;
      }
      /* Responsive Adjustments */
      @media (max-width: 600px) {
        .desktop-app img {
          width: 48px;
          height: 48px;
        }
        #settings-sidebar {
          width: 200px;
          padding: 15px;
        }
        #settings-content {
          padding: 20px;
        }
        .setup-step {
          max-width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Jfi Connection Modal -->
    <div id="jfiModal" class="modal">
      <div class="modal-content">
        <span id="closeJfiModal" class="close">&times;</span>
        <h2>Connect to Jfi</h2>
        <input type="text" id="jfiWsUrl" placeholder="ws://yourserver:port" />
        <button id="connectJfiBtn">Connect</button>
        <p id="jfiStatus"></p>
      </div>
    </div>

    <!-- OS Container (brightness controlled) -->
    <div id="osContainer">
      <div id="gamebar" style="display: none;">
        <button id="gm-left" onclick="cycleApp(-1)">&#9664;</button>
        <div id="gm-launcher" onclick="launchGMApp()"></div>
        <button id="gm-right" onclick="cycleApp(1)">&#9654;</button>
        <div id="gm-clock"></div>
        <button id="gm-widgets-btn" onclick="toggleWidgetsMenu()">Widgets</button>
      </div>
      <!-- Mini Menu -->
      <div id="miniMenu">
        <div class="menuItem" id="jfiButton">
          <img src="images/icons/minimenu/jfi.png" alt="Jfi" />
          <span>Jfi</span>
        </div>
        <div class="menuItem">
          <img src="images/icons/minimenu/connect.png" alt="Connect" />
          <span>Connect</span>
        </div>
        <div class="menuItem">
          <img src="images/icons/minimenu/brightness.png" alt="Brightness" />
          <input type="range" id="brightnessSlider" min="0" max="100" value="100" />
        </div>
        <div class="batteryInfo">
          <div id="batteryContainerSys">
            <div id="batteryLevelSys" style="width: 0%;"></div>
          </div>
          <span id="batteryPercentBottom">--%</span>
        </div>
      </div>
      <div id="desktop"></div>
      <div id="search-menu" class="search-menu" style="display: none;">
        <span class="close-btn" onclick="toggleSearchMenu()">
          <img src="images/icons/x.png" alt="Close" />
        </span>
        <input type="text" placeholder="Search apps..." oninput="filterApps(this.value)" />
        <div id="app-list"></div>
      </div>
    </div>

    <!-- TASKBAR (outside osContainer) -->
    <div id="taskbar">
      <button id="start-button" class="taskbar-button" onclick="toggleSearchMenu()">❖</button>
      <button id="gm-button" class="taskbar-button" onclick="toggleGameBar()">
        <img id="gm-icon" src="images/icons/gm/off.png" alt="Game Mode" />
      </button>
      <div id="open-apps"></div>
      <div id="taskbar-right">
        <div id="clock-container">
          <span id="date"></span>
          <span id="clock"></span>
        </div>
        <button id="systemMenuBtn" class="taskbar-button">
          <img src="images/icons/wifi.png" alt="WiFi" style="width:32px;height:32px;" />
          <div id="batteryContainer">
            <div id="batteryLevel" style="width: 0%;"></div>
          </div>
          <span id="batteryPercent">--%</span>
        </button>
        <button class="lock-button" onclick="showPasswordModal()">Lock</button>
        <button onclick="powerOff()" class="power-button">Power Down</button>
      </div>
    </div>

    <script>
      // Update clock and date
      function updateClock() {
        const now = new Date();
        const clock = document.getElementById("clock");
        const date = document.getElementById("date");
        if (clock && date) {
          clock.innerText = now.toLocaleTimeString();
          date.innerText = now.toLocaleDateString();
        }
      }

      // Remove login flag on boot
      document.addEventListener("DOMContentLoaded", () => {
        sessionStorage.removeItem("loggedIn");
      });

      /* Global Variables */
      let installedApps = [];
      let openApps = [];
      let gameModeOn = false;
      let gmApps = [];
      let gmCurrentIndex = 0;
      let gamepadInterval = null;

      /* Load installed apps from localStorage */
      function loadInstalledApps() {
        return new Promise((resolve) => {
          installedApps = localStorage.getItem("installedApps")
            ? JSON.parse(localStorage.getItem("installedApps"))
            : [];
          resolve();
        });
      }

      /* OS Theme Functions */
      function saveOSTheme(osName) {
        localStorage.setItem("osTheme", osName);
      }
      function changeOS(osName) {
        saveOSTheme(osName);
        const stylesheet = document.querySelector('link[rel="stylesheet"]');
        const startBtn = document.getElementById("start-button");
        if (!stylesheet || !startBtn) {
          console.error("Stylesheet or start button not found.");
          return;
        }
        if (osName === "default") {
          stylesheet.href = "assets/css/default.css";
          startBtn.innerHTML = "❖";
        } else {
          stylesheet.href = "assets/css/" + osName + ".css";
          startBtn.innerHTML = `<img src="images/icons/${osName}/start.png" onerror="this.onerror=null; this.src='/images/icons/${osName}/start.jpg'" alt="Start">`;
        }
      }
      function restoreOSTheme() {
        const savedOS = localStorage.getItem("osTheme");
        if (savedOS) changeOS(savedOS);
      }

      /* App Installation Functions */
      function installJstoreIfNotInstalled() {
        if (!installedApps.some(app => app.name === "Jstore")) {
          installApp("Jstore", "apps/icons/jstore.png", "");
          const jstoreApp = installedApps.find(app => app.name === "Jstore");
          if (jstoreApp) {
            jstoreApp.htmlContent = `
              <div id="jstore-container">
                <h1>Jstore</h1>
                <input type="text" id="jstore-search" placeholder="Search apps..." oninput="filterJstoreApps(this.value)" />
                <div id="jstore-app-list"></div>
              </div>
            `;
            localStorage.setItem("installedApps", JSON.stringify(installedApps));
          }
        }
      }
      function installSettingsIfNotInstalled() {
        if (!installedApps.some(app => app.name === "Settings")) {
          installApp("Settings", "apps/icons/settings.png", "");
          const settingsApp = installedApps.find(app => app.name === "Settings");
          if (settingsApp) {
            settingsApp.htmlContent = `
              <div id="settings-app">
                <div id="settings-sidebar">
                  <input type="text" id="settings-search" placeholder="Search settings..." />
                  <ul id="settings-options">
                    <li data-tab="personalization">
                      <img src="https://jxoj.github.io/Jxo-OS/images/icons/settings/sidebar/personalization.webp" alt="Personalization" />
                      <span>Personalization</span>
                    </li>
                    <li data-tab="account">
                      <img src="https://jxoj.github.io/Jxo-OS/images/icons/settings/sidebar/account.webp" alt="Account" />
                      <span>Account</span>
                    </li>
                  </ul>
                </div>
                <div id="settings-content"></div>
              </div>
            `;
            localStorage.setItem("installedApps", JSON.stringify(installedApps));
          }
        }
      }
      function loadJstoreApps() {
        fetch("https://jxoj.github.io/Jxo-OS/apps/apps.json")
          .then(response => { if (!response.ok) throw new Error("Network error"); return response.json(); })
          .then(apps => {
            const list = document.getElementById("jstore-app-list");
            if (!list) return;
            list.innerHTML = "";
            apps.forEach(app => {
              const isInstalled = installedApps.some(a => a.name === app.name);
              const button = document.createElement("button");
              button.dataset.icon = app.icon;
              button.dataset.url = app.url;
              button.textContent = isInstalled ? "Uninstall" : "Install";
              button.onclick = () => {
                isInstalled
                  ? uninstallJstoreApp(app.name, button)
                  : installJstoreApp(app.name, app.icon, app.url, button);
              };
              const appDiv = document.createElement("div");
              appDiv.classList.add("jstore-app-item");
              appDiv.innerHTML = `<img src="${app.icon}" alt="${app.name} icon"><span style="flex-grow:1;">${app.name}</span>`;
              appDiv.appendChild(button);
              list.appendChild(appDiv);
            });
          })
          .catch(error => {
            console.error("Failed to load Jstore apps:", error);
            const list = document.getElementById("jstore-app-list");
            if (list) list.innerHTML = "<p>Error loading apps.</p>";
          });
      }
      function installJstoreApp(name, icon, url, button) {
        installApp(name, icon, url);
        button.textContent = "Uninstall";
        button.onclick = () => uninstallJstoreApp(name, button);
      }
      function uninstallJstoreApp(name, button) {
        uninstallApp(name);
        button.textContent = "Install";
        button.onclick = () => installJstoreApp(name, button.dataset.icon, button.dataset.url, button);
      }
      function installApp(name, image, iframeUrl) {
        const newApp = { name, appId: name.toLowerCase().replace(/\s+/g, ""), image, htmlUrl: iframeUrl };
        installedApps.push(newApp);
        localStorage.setItem("installedApps", JSON.stringify(installedApps));
        renderDesktop();
      }
      function uninstallApp(appName) {
        installedApps = installedApps.filter(app => app.name.toLowerCase() !== appName.toLowerCase());
        localStorage.setItem("installedApps", JSON.stringify(installedApps));
        renderDesktop();
      }

      /* Settings App Functions */
      function initSettingsApp() {
        const searchInput = document.getElementById("settings-search");
        const optionsList = document.getElementById("settings-options");
        if (searchInput && optionsList) {
          searchInput.addEventListener("input", () => {
            const query = searchInput.value.toLowerCase();
            Array.from(optionsList.getElementsByTagName("li")).forEach(li => {
              li.style.display = li.textContent.toLowerCase().includes(query) ? "" : "none";
            });
          });
        }
        const sidebarItems = document.querySelectorAll("#settings-options li");
        sidebarItems.forEach(item => {
          item.addEventListener("click", () => {
            sidebarItems.forEach(i => i.classList.remove("active"));
            item.classList.add("active");
            const tab = item.getAttribute("data-tab");
            if (tab === "personalization") loadPersonalizationTab();
            else if (tab === "account") loadAccountTab();
          });
        });
        loadPersonalizationTab();
      }
      function loadPersonalizationTab() {
        const content = document.getElementById("settings-content");
        if (!content) return;
        const wallpapers = [];
        for (let i = 1; i <= 41; i++) {
          wallpapers.push("wallpaper" + i);
        }
        const osOptions = ["default", "windows10"];
        content.innerHTML = `
          <h2>Personalization</h2>
          <div style="margin-bottom:20px;">
            <h3>Change OS Theme</h3>
            <select id="os-dropdown">
              ${osOptions.map(os => `<option value="${os}">${os}</option>`).join("")}
            </select>
          </div>
          <div style="margin-bottom:20px;">
            <h3>Change Background Image</h3>
            <div id="bg-preview-container">
              <img id="bg-preview" src="images/backgrounds/wallpaper1.jpg" alt="Background Preview" />
            </div>
            <select id="wallpaper-dropdown">
              ${wallpapers.map(wp => `<option value="images/backgrounds/${wp}.jpg">${wp}.jpg</option>`).join("")}
            </select>
          </div>
          <div style="margin-bottom:20px;">
            <h3>Change Background Color</h3>
            <input type="color" id="bg-color-picker" />
          </div>
          <div style="margin-bottom:20px;">
            <h3>Toggle Light/Dark Mode</h3>
            <select id="mode-toggle">
              <option value="dark">Dark Mode</option>
              <option value="light">Light Mode</option>
            </select>
          </div>
        `;
        const osDropdown = document.getElementById("os-dropdown");
        osDropdown.value = localStorage.getItem("osTheme") || "default";
        osDropdown.addEventListener("change", () => changeOS(osDropdown.value));
        const wallpaperDropdown = document.getElementById("wallpaper-dropdown");
        const bgPreview = document.getElementById("bg-preview");
        if (wallpaperDropdown && bgPreview) {
          wallpaperDropdown.value = "images/backgrounds/wallpaper1.jpg";
          bgPreview.src = wallpaperDropdown.value;
          wallpaperDropdown.addEventListener("change", () => {
            const selected = wallpaperDropdown.value;
            bgPreview.src = selected;
            changeBackgroundimage(selected);
          });
        }
        const colorPicker = document.getElementById("bg-color-picker");
        colorPicker.addEventListener("input", () => {
          const hex = colorPicker.value;
          const r = parseInt(hex.substr(1, 2), 16);
          const g = parseInt(hex.substr(3, 2), 16);
          const b = parseInt(hex.substr(5, 2), 16);
          changeBackground(r, g, b);
        });
        const modeToggle = document.getElementById("mode-toggle");
        modeToggle.value = localStorage.getItem("mode") || "dark";
        modeToggle.addEventListener("change", () => toggleLightDark(modeToggle.value));
        toggleLightDark(modeToggle.value);
      }
      function loadAccountTab() {
        const content = document.getElementById("settings-content");
        if (!content) return;
        content.innerHTML = `
          <h2>Account</h2>
          <div style="background:#333; padding:20px; border-radius:8px; max-width:400px;">
            <div style="margin-bottom:10px;">
              <label style="display:block; margin-bottom:5px;">New Username:</label>
              <input type="text" id="new-username" placeholder="Enter new username" />
            </div>
            <div style="margin-bottom:10px;">
              <label style="display:block; margin-bottom:5px;">New Password:</label>
              <input type="password" id="new-password" placeholder="Enter new password" />
              <button class="toggle-password" onclick="toggleInputPassword('new-password', this)">
                <img src="images/icons/setup/show.png" alt="Show" />
              </button>
            </div>
            <button onclick="updateAccount(document.getElementById('new-username').value, document.getElementById('new-password').value)" style="padding:10px 20px; background:#555; border:none; border-radius:4px; cursor:pointer; color:#e0e0e0;">Update Account</button>
            <div id="account-message" style="margin-top:10px;"></div>
          </div>
        `;
      }
      function toggleInputPassword(id, btn) {
        const input = document.getElementById(id);
        if (input.type === "password") {
          input.type = "text";
          btn.innerHTML = `<img src="images/icons/setup/hide.png" alt="Hide" />`;
        } else {
          input.type = "password";
          btn.innerHTML = `<img src="images/icons/setup/show.png" alt="Show" />`;
        }
      }
      function changePassword(newPassword) {
        localStorage.setItem("password", newPassword);
      }
      function updateAccount(newUsername, newPassword) {
        localStorage.setItem("username", newUsername);
        changePassword(newPassword);
        const msg = document.getElementById("account-message");
        if (msg) msg.innerText = "Account updated successfully!";
      }
      function showPasswordModal() {
        let modal = document.createElement("div");
        modal.classList.add("password-modal");
        let profilePic = localStorage.getItem("profilePic") || "images/icons/profile/profile.png";
        if (localStorage.getItem("password")) {
          let usernameField = localStorage.getItem("username")
            ? `<p>Welcome, ${localStorage.getItem("username")}!</p>`
            : `<input type="text" id="username-input" placeholder="Enter your username" />`;
          modal.innerHTML = `
            <div class="password-modal-content">
              <img src="${profilePic}" alt="Profile Icon" />
              ${usernameField}
              <h3>Enter Password</h3>
              <div style="display:inline-flex; align-items:center;">
                <input type="password" id="entered-password" placeholder="Enter password" />
                <button class="toggle-password" onclick="toggleInputPassword('entered-password', this)">
                  <img src="images/icons/setup/show.png" alt="Show" />
                </button>
              </div>
              <br />
              <button onclick="checkPassword()">Enter</button>
            </div>
          `;
        } else {
          modal.innerHTML = `
            <div class="password-modal-content">
              <img src="${profilePic}" alt="Profile Icon" />
              <h3>Set up your account</h3>
              <input type="text" id="username-input" placeholder="Enter your username" />
              <br />
              <input type="password" id="new-password" placeholder="Enter new password" />
              <br />
              <button onclick="setCredentials()">Set Credentials</button>
            </div>
          `;
        }
        document.body.appendChild(modal);
      }
      function checkPassword() {
        const entered = document.getElementById("entered-password").value;
        const stored = localStorage.getItem("password");
        if (entered === stored) {
          document.querySelector(".password-modal").remove();
        } else {
          alert("Incorrect password!");
        }
      }
      function setCredentials() {
        const username = document.getElementById("username-input").value;
        const newPass = document.getElementById("new-password").value;
        if (username && newPass) {
          localStorage.setItem("username", username);
          localStorage.setItem("password", newPass);
          document.querySelector(".password-modal").remove();
        } else {
          alert("Username and password cannot be empty!");
        }
      }

      /* Game Bar Functions */
      function toggleGameBar() {
        const gb = document.getElementById("gamebar");
        if (gb.style.display === "none" || gb.style.display === "") {
          gb.style.display = "flex";
          document.getElementById("gm-icon").src = "images/icons/gm/on.png";
          gmApps = installedApps.filter(app => app.name !== "Settings" && app.name !== "Jstore");
          if (gmApps.length > 0) {
            gmCurrentIndex = Math.floor(Math.random() * gmApps.length);
            updateGMLauncher();
          }
          startGamepadPolling();
        } else {
          gb.style.display = "none";
          document.getElementById("gm-icon").src = "images/icons/gm/off.png";
          stopGamepadPolling();
        }
      }
      function updateGMLauncher() {
        const launcher = document.getElementById("gm-launcher");
        if (gmApps.length === 0) {
          launcher.innerHTML = "No apps available";
          return;
        }
        const app = gmApps[gmCurrentIndex];
        launcher.innerHTML = `<img src="${app.image}" alt="${app.name} icon" />${app.name}`;
      }
      function cycleApp(direction) {
        if (gmApps.length === 0) return;
        gmCurrentIndex = (gmCurrentIndex + direction + gmApps.length) % gmApps.length;
        updateGMLauncher();
      }
      function launchGMApp() {
        if (gmApps.length === 0) return;
        const app = gmApps[gmCurrentIndex];
        if (app.htmlUrl) {
          let url = app.htmlUrl;
          url += (url.indexOf("?") === -1) ? "?controller=true" : "&controller=true";
          openAppWindowWithUrl(app.appId, url);
        } else {
          openAppWindow(app.appId);
        }
      }
      function openAppWindowWithUrl(appId, url) {
        const app = installedApps.find(app => app.appId === appId);
        if (app && !document.getElementById(appId)) {
          const win = document.createElement("div");
          win.classList.add("app-window");
          win.id = appId;
          win.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close" />
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen" />
                </button>
              </div>
            </div>
            <div class="window-content">
              ${app.htmlContent ? app.htmlContent : `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(win);
          makeDraggable(win);
          makeResizable(win);
          openApps.push(appId);
          updateTaskbar();
        }
      }
      function startGamepadPolling() {
        if (gamepadInterval) return;
        gamepadInterval = setInterval(() => {
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          if (!gamepads) return;
          for (let gp of gamepads) {
            if (gp) {
              if (gp.buttons[14] && gp.buttons[14].pressed) { cycleApp(-1); }
              if (gp.buttons[15] && gp.buttons[15].pressed) { cycleApp(1); }
              if (gp.buttons[0] && gp.buttons[0].pressed) { launchGMApp(); }
              let axis = gp.axes[0];
              if (axis < -0.5) { cycleApp(-1); }
              if (axis > 0.5) { cycleApp(1); }
            }
          }
        }, 100);
      }
      function stopGamepadPolling() {
        if (gamepadInterval) {
          clearInterval(gamepadInterval);
          gamepadInterval = null;
        }
      }

      /* Mini Menu and Battery Functions */
      function attachSystemMenuListener() {
        const sysBtn = document.getElementById("systemMenuBtn");
        const miniMenu = document.getElementById("miniMenu");
        if (sysBtn && miniMenu) {
          sysBtn.addEventListener("click", () => {
            if (miniMenu.style.display === "block") {
              miniMenu.style.display = "none";
            } else {
              const rect = sysBtn.getBoundingClientRect();
              miniMenu.style.left = rect.left + "px";
              miniMenu.style.bottom = (window.innerHeight - rect.top + 5) + "px";
              miniMenu.style.display = "block";
            }
          });
        }
        const jfiBtn = document.getElementById("jfiButton");
        if (jfiBtn) {
          jfiBtn.addEventListener("click", () => {
            document.getElementById("jfiModal").style.display = "block";
          });
        }
        const brightnessSlider = document.getElementById("brightnessSlider");
        if (brightnessSlider) {
          brightnessSlider.addEventListener("input", updateBrightness);
        }
      }
      function updateBrightness() {
        const brightnessSlider = document.getElementById("brightnessSlider");
        if (brightnessSlider) {
          const val = brightnessSlider.value;
          const osContainer = document.getElementById("osContainer");
          if (osContainer) {
            osContainer.style.filter = "brightness(" + val + "%)";
          }
        }
      }
      function updateBatteryInfo() {
        if (navigator.getBattery) {
          navigator.getBattery().then(battery => {
            const level = battery.level;
            const levelText = Math.round(level * 100) + "%";
            const batteryLevel = document.getElementById("batteryLevel");
            const batteryPercentElem = document.getElementById("batteryPercent");
            if (batteryLevel) batteryLevel.style.width = (level * 100) + "%";
            if (batteryPercentElem) batteryPercentElem.textContent = levelText;
            const batteryLevelSys = document.getElementById("batteryLevelSys");
            const batteryPercentBottomElem = document.getElementById("batteryPercentBottom");
            if (batteryLevelSys) batteryLevelSys.style.width = (level * 100) + "%";
            if (batteryPercentBottomElem) batteryPercentBottomElem.textContent = levelText;
          });
        }
      }
      setInterval(updateBatteryInfo, 1000);

      /* Game Bar Widgets */
      function updateGameBarWidgets() {
        const gmClock = document.getElementById("gm-clock");
        if (gmClock) {
          const timeStr = new Date().toLocaleTimeString();
          if (navigator.getBattery) {
            navigator.getBattery().then(battery => {
              const level = Math.round(battery.level * 100) + "%";
              gmClock.innerText = timeStr + " | " + level;
            });
          } else {
            gmClock.innerText = timeStr + " | N/A";
          }
        }
      }
      setInterval(updateGameBarWidgets, 1000);

      /* Widgets Menu (Placeholder) */
      function toggleWidgetsMenu() {
        const wm = document.getElementById("widgets-menu");
        wm.style.display = (wm.style.display === "block") ? "none" : "block";
      }
      function initWidgetsMenu() {
        if (!document.getElementById("widgets-menu")) {
          const wm = document.createElement("div");
          wm.id = "widgets-menu";
          wm.innerHTML = `
            <div class="widget" id="widget-spotify">Spotify Player (Placeholder)</div>
            <div class="widget" id="widget-clock">Clock Widget (Placeholder)</div>
          `;
          document.body.appendChild(wm);
          makeDraggable(wm);
          setInterval(() => {
            const widgetClock = document.getElementById("widget-clock");
            if (widgetClock) widgetClock.innerText = new Date().toLocaleTimeString();
          }, 1000);
        }
      }

      /* Jfi Connection Modal Functions */
      document.getElementById("closeJfiModal")?.addEventListener("click", () => {
        document.getElementById("jfiModal").style.display = "none";
      });
      document.getElementById("connectJfiBtn")?.addEventListener("click", () => {
        const url = document.getElementById("jfiWsUrl").value;
        const status = document.getElementById("jfiStatus");
        try {
          const ws = new WebSocket(url);
          ws.onopen = () => {
            status.textContent = "Connected to Jfi!";
            status.style.color = "lime";
          };
          ws.onmessage = msg => {
            console.log("Jfi Message:", msg.data);
          };
          ws.onerror = e => {
            status.textContent = "Error connecting!";
            status.style.color = "red";
          };
          ws.onclose = () => {
            status.textContent = "Disconnected.";
          };
        } catch (e) {
          status.textContent = "Invalid WebSocket URL.";
          status.style.color = "red";
        }
      });

      /* Boot Screen and OS Loading */
      function showBootScreen() {
        document.body.innerHTML = `
          <div id="boot-screen" class="boot-screen">
            <div class="boot-content">
              <span class="boot-title" style="font-size:4em;">Jx</span>
              <div class="loading-circle"></div>
            </div>
          </div>
        `;
        setTimeout(() => { loadOS(); showPasswordModal(); }, 2000);
      }
      function loadOS() {
        document.body.innerHTML = `
          <div id="osContainer">
            <div id="gamebar" style="display: none;">
              <button id="gm-left" onclick="cycleApp(-1)">&#9664;</button>
              <div id="gm-launcher" onclick="launchGMApp()"></div>
              <button id="gm-right" onclick="cycleApp(1)">&#9654;</button>
              <div id="gm-clock"></div>
              <button id="gm-widgets-btn" onclick="toggleWidgetsMenu()">Widgets</button>
            </div>
            <div id="miniMenu">
              <div class="menuItem" id="jfiButton">
                <img src="images/icons/minimenu/jfi.png" alt="Jfi" />
                <span>Jfi</span>
              </div>
              <div class="menuItem">
                <img src="images/icons/minimenu/connect.png" alt="Connect" />
                <span>Connect</span>
              </div>
              <div class="menuItem">
                <img src="images/icons/minimenu/brightness.png" alt="Brightness" />
                <input type="range" id="brightnessSlider" min="0" max="100" value="100" />
              </div>
              <div class="batteryInfo">
                <div id="batteryContainerSys">
                  <div id="batteryLevelSys" style="width: 0%;"></div>
                </div>
                <span id="batteryPercentBottom">--%</span>
              </div>
            </div>
            <div id="desktop"></div>
            <div id="search-menu" class="search-menu" style="display: none;">
              <span class="close-btn" onclick="toggleSearchMenu()">
                <img src="images/icons/x.png" alt="Close" />
              </span>
              <input type="text" placeholder="Search apps..." oninput="filterApps(this.value)" />
              <div id="app-list"></div>
            </div>
          </div>
          <div id="taskbar" class="taskbar">
            <button id="start-button" class="taskbar-button" onclick="toggleSearchMenu()">❖</button>
            <button id="gm-button" class="taskbar-button" onclick="toggleGameBar()">
              <img id="gm-icon" src="images/icons/gm/off.png" alt="Game Mode" />
            </button>
            <div id="open-apps"></div>
            <div id="taskbar-right">
              <div id="clock-container">
                <span id="date"></span>
                <span id="clock"></span>
              </div>
              <button id="systemMenuBtn" class="taskbar-button">
                <img src="images/icons/wifi.png" alt="WiFi" style="width:32px;height:32px;" />
                <div id="batteryContainer">
                  <div id="batteryLevel" style="width: 0%;"></div>
                </div>
                <span id="batteryPercent">--%</span>
              </button>
              <button class="lock-button" onclick="showPasswordModal()">Lock</button>
              <button onclick="powerOff()" class="power-button">Power Down</button>
            </div>
          </div>
          <div id="search-menu" class="search-menu" style="display: none;">
            <span class="close-btn" onclick="toggleSearchMenu()">
              <img src="images/icons/x.png" alt="Close" />
            </span>
            <input type="text" placeholder="Search apps..." oninput="filterApps(this.value)" />
            <div id="app-list"></div>
          </div>
        `;
        installJstoreIfNotInstalled();
        installSettingsIfNotInstalled();
        renderDesktop();
        updateTaskbar();
        restoreOSTheme();
        setInterval(updateClock, 1000);
        setInterval(updateBatteryInfo, 1000);
        initWidgetsMenu();
        attachSystemMenuListener();
      }

      /* Background functions */
      function loadBackground() {
        const background = localStorage.getItem("background");
        if (background) document.body.style.background = background;
      }
      function saveBackground(backgroundValue) {
        localStorage.setItem("background", backgroundValue);
        loadBackground();
      }
      function changeBackground(r, g, b) {
        const color = `rgb(${r}, ${g}, ${b})`;
        document.body.style.background = color;
        saveBackground(color);
      }
      function changeBackgroundimage(url) {
        const bg = `url(${url}) center center/cover no-repeat fixed`;
        document.body.style.background = bg;
        saveBackground(bg);
      }

      /* Desktop, App Windows, Taskbar Functions */
      function renderDesktop() {
        const desktop = document.getElementById("desktop");
        if (!desktop) return;
        desktop.innerHTML = "";
        installedApps.forEach(app => {
          const appShortcut = document.createElement("div");
          appShortcut.classList.add("desktop-app");
          appShortcut.innerHTML = `<img src="${app.image}" alt="${app.name} icon" /><span>${app.name}</span>`;
          appShortcut.onclick = () => openAppWindow(app.appId);
          desktop.appendChild(appShortcut);
        });
      }
      function openAppWindow(appId) {
        const app = installedApps.find(app => app.appId === appId);
        if (app) {
          if (document.getElementById(appId)) return;
          const appWindow = document.createElement("div");
          appWindow.classList.add("app-window");
          appWindow.id = appId;
          appWindow.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close" />
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen" />
                </button>
              </div>
            </div>
            <div class="window-content">
              ${app.htmlContent ? app.htmlContent : `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(appWindow);
          makeDraggable(appWindow);
          makeResizable(appWindow);
          openApps.push(appId);
          updateTaskbar();
          if (appId === "jstore") setTimeout(loadJstoreApps, 100);
          if (appId === "settings") setTimeout(initSettingsApp, 100);
        }
      }
      function closeWindow(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) {
          appWindow.remove();
          openApps = openApps.filter(id => id !== appId);
          updateTaskbar();
        }
      }
      function toggleFullscreen(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) {
          if (appWindow.style.position === "fixed") {
            appWindow.style.position = "absolute";
            appWindow.style.width = "600px";
            appWindow.style.height = "400px";
            appWindow.style.zIndex = "";
          } else {
            appWindow.style.position = "fixed";
            appWindow.style.top = "0";
            appWindow.style.left = "0";
            appWindow.style.width = "100vw";
            appWindow.style.height = "100vh";
            appWindow.style.zIndex = "10000";
          }
        }
      }
      function makeDraggable(el) {
        const header = el.querySelector(".window-header") || el;
        let isDragging = false, offsetX = 0, offsetY = 0;
        header.addEventListener("mousedown", e => {
          isDragging = true;
          offsetX = e.clientX - el.offsetLeft;
          offsetY = e.clientY - el.offsetTop;
        });
        el.addEventListener("mousemove", e => {
          if (isDragging) {
            el.style.left = `${e.clientX - offsetX}px`;
            el.style.top = `${e.clientY - offsetY}px`;
          }
        });
        el.addEventListener("mouseup", () => { isDragging = false; });
      }
      function makeResizable(el) {
        const handle = el.querySelector(".resize-handle");
        let isResizing = false, lastX, lastY;
        handle.addEventListener("mousedown", e => { isResizing = true; lastX = e.clientX; lastY = e.clientY; e.preventDefault(); });
        window.addEventListener("mousemove", e => {
          if (isResizing) {
            const dx = e.clientX - lastX, dy = e.clientY - lastY;
            el.style.width = el.offsetWidth + dx + "px";
            el.style.height = el.offsetHeight + dy + "px";
            lastX = e.clientX;
            lastY = e.clientY;
          }
        });
        window.addEventListener("mouseup", () => { isResizing = false; });
      }
      function updateTaskbar() {
        const container = document.getElementById("open-apps");
        container.innerHTML = "";
        openApps.forEach(appId => {
          const app = installedApps.find(app => app.appId === appId);
          if (app) {
            const img = document.createElement("img");
            img.src = app.image;
            img.alt = app.name;
            img.title = app.name;
            img.style.width = "32px";
            img.style.height = "32px";
            img.style.cursor = "pointer";
            img.onclick = () => bringToFront(appId);
            container.appendChild(img);
          }
        });
      }
      function bringToFront(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) document.body.appendChild(appWindow);
      }
      function powerOff() {
        document.body.innerHTML = `
          <div class="shutdown-screen">
            <h2>Shutting down...</h2>
            <p>Goodbye!</p>
            <button onclick="location.reload()">Reboot</button>
          </div>
        `;
      }

      /* Setup Screen */
      function showSetupScreen() {
        const container = document.createElement("div");
        container.classList.add("setup-screen");
        document.body.appendChild(container);
        let currentStep = 1;
        const data = { username: "", password: "", profilePic: "", wallpaper: "", osTheme: "", colorScheme: "" };
        function renderStep() {
          switch (currentStep) {
            case 1:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Let's get you setup</h2>
                  <p>Please choose your username and password.</p>
                  <input type="text" id="setup-username" placeholder="Username" />
                  <div>
                    <input type="password" id="setup-password" placeholder="Password" />
                    <button class="toggle-password" onclick="toggleInputPassword('setup-password', this)">
                      <img src="images/icons/setup/show.png" alt="Show" />
                    </button>
                  </div>
                  <button id="setup-next">Next</button>
                </div>
              `;
              document.getElementById("setup-next").addEventListener("click", () => {
                const u = document.getElementById("setup-username").value.trim();
                const p = document.getElementById("setup-password").value.trim();
                if (u && p) { data.username = u; data.password = p; currentStep++; renderStep(); }
                else { alert("Username and password cannot be empty!"); }
              });
              break;
            case 2:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Choose a Profile Picture</h2>
                  <p>This is optional. Upload one if you like:</p>
                  <div class="file-input-wrapper">
                    <span class="file-input-label">Choose File</span>
                    <input type="file" id="profile-upload" accept="image/*" />
                  </div>
                  <img id="profile-preview" class="preview-img" src="images/icons/profile/profile.png" alt="Profile Preview" />
                  <br />
                  <button id="setup-skip">Skip</button>
                  <button id="setup-next">Next</button>
                </div>
              `;
              document.getElementById("profile-upload").addEventListener("change", e => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = evt => {
                    document.getElementById("profile-preview").src = evt.target.result;
                    data.profilePic = evt.target.result;
                  };
                  reader.readAsDataURL(file);
                }
              });
              document.getElementById("setup-skip").addEventListener("click", () => {
                data.profilePic = "images/icons/profile/profile.png";
                currentStep++;
                renderStep();
              });
              document.getElementById("setup-next").addEventListener("click", () => {
                if (!data.profilePic) data.profilePic = "images/icons/profile/profile.png";
                currentStep++;
                renderStep();
              });
              break;
            case 3:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Choose your Default Wallpaper</h2>
                  <p>Select a wallpaper for your desktop.</p>
                  <select id="setup-wallpaper-select">
                    ${(() => { let opts = ""; for (let i = 1; i <= 41; i++) { opts += `<option value="images/backgrounds/wallpaper${i}.jpg">Wallpaper ${i}</option>`; } return opts; })()}
                  </select>
                  <br />
                  <img id="wallpaper-preview" class="preview-img" src="images/backgrounds/wallpaper1.jpg" alt="Wallpaper Preview" />
                  <br />
                  <button id="setup-next">Next</button>
                </div>
              `;
              document.getElementById("setup-wallpaper-select").addEventListener("change", e => {
                const sel = e.target.value;
                document.getElementById("wallpaper-preview").src = sel;
                data.wallpaper = sel;
              });
              document.getElementById("setup-next").addEventListener("click", () => {
                if (!data.wallpaper) data.wallpaper = document.getElementById("setup-wallpaper-select").value;
                currentStep++;
                renderStep();
              });
              break;
            case 4:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Setup OS Theme & Color Scheme</h2>
                  <p>Select your OS theme and color scheme.</p>
                  <div style="margin-bottom:10px;">
                    <label>OS Theme:</label>
                    <select id="setup-ostheme">
                      <option value="default">Default</option>
                      <option value="windows10">Windows10</option>
                    </select>
                  </div>
                  <div style="margin-bottom:10px;">
                    <label>Color Scheme:</label>
                    <select id="setup-colorscheme">
                      <option value="dark">Dark</option>
                      <option value="light">Light</option>
                    </select>
                  </div>
                  <button id="setup-finish">Finish</button>
                </div>
              `;
              const colorSchemeSelect = document.getElementById("setup-colorscheme");
              colorSchemeSelect.addEventListener("change", function () { toggleLightDark(this.value); });
              document.getElementById("setup-finish").addEventListener("click", () => {
                data.osTheme = document.getElementById("setup-ostheme").value;
                data.colorScheme = document.getElementById("setup-colorscheme").value;
                toggleLightDark(data.colorScheme);
                localStorage.setItem("username", data.username);
                localStorage.setItem("password", data.password);
                localStorage.setItem("profilePic", data.profilePic);
                localStorage.setItem("background", data.wallpaper);
                localStorage.setItem("osTheme", data.osTheme);
                localStorage.setItem("colorScheme", data.colorScheme);
                localStorage.setItem("setupComplete", "true");
                changeBackgroundimage(data.wallpaper);
                sessionStorage.removeItem("loggedIn");
                container.remove();
                showBootScreen();
              });
              break;
            default:
              break;
          }
        }
        renderStep();
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadInstalledApps().then(() => {
          loadBackground();
          if (!localStorage.getItem("setupComplete")) showSetupScreen();
          else showBootScreen();
        });
      });

      /* Background functions */
      function loadBackground() {
        const background = localStorage.getItem("background");
        if (background) document.body.style.background = background;
      }
      function saveBackground(backgroundValue) {
        localStorage.setItem("background", backgroundValue);
        loadBackground();
      }
      function changeBackground(r, g, b) {
        const color = `rgb(${r}, ${g}, ${b})`;
        document.body.style.background = color;
        saveBackground(color);
      }
      function changeBackgroundimage(url) {
        const bg = `url(${url}) center center/cover no-repeat fixed`;
        document.body.style.background = bg;
        saveBackground(bg);
      }

      /* Desktop, App Windows, Taskbar Functions */
      function renderDesktop() {
        const desktop = document.getElementById("desktop");
        if (!desktop) return;
        desktop.innerHTML = "";
        installedApps.forEach(app => {
          const appShortcut = document.createElement("div");
          appShortcut.classList.add("desktop-app");
          appShortcut.innerHTML = `<img src="${app.image}" alt="${app.name} icon" /><span>${app.name}</span>`;
          appShortcut.onclick = () => openAppWindow(app.appId);
          desktop.appendChild(appShortcut);
        });
      }
      function openAppWindow(appId) {
        const app = installedApps.find(app => app.appId === appId);
        if (app) {
          if (document.getElementById(appId)) return;
          const appWindow = document.createElement("div");
          appWindow.classList.add("app-window");
          appWindow.id = appId;
          appWindow.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close" />
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen" />
                </button>
              </div>
            </div>
            <div class="window-content">
              ${app.htmlContent ? app.htmlContent : `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(appWindow);
          makeDraggable(appWindow);
          makeResizable(appWindow);
          openApps.push(appId);
          updateTaskbar();
          if (appId === "jstore") setTimeout(loadJstoreApps, 100);
          if (appId === "settings") setTimeout(initSettingsApp, 100);
        }
      }
      function closeWindow(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) {
          appWindow.remove();
          openApps = openApps.filter(id => id !== appId);
          updateTaskbar();
        }
      }
      function toggleFullscreen(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) {
          if (appWindow.style.position === "fixed") {
            appWindow.style.position = "absolute";
            appWindow.style.width = "600px";
            appWindow.style.height = "400px";
            appWindow.style.zIndex = "";
          } else {
            appWindow.style.position = "fixed";
            appWindow.style.top = "0";
            appWindow.style.left = "0";
            appWindow.style.width = "100vw";
            appWindow.style.height = "100vh";
            appWindow.style.zIndex = "10000";
          }
        }
      }
      function makeDraggable(el) {
        const header = el.querySelector(".window-header") || el;
        let isDragging = false, offsetX = 0, offsetY = 0;
        header.addEventListener("mousedown", e => {
          isDragging = true;
          offsetX = e.clientX - el.offsetLeft;
          offsetY = e.clientY - el.offsetTop;
        });
        el.addEventListener("mousemove", e => {
          if (isDragging) {
            el.style.left = `${e.clientX - offsetX}px`;
            el.style.top = `${e.clientY - offsetY}px`;
          }
        });
        el.addEventListener("mouseup", () => { isDragging = false; });
      }
      function makeResizable(el) {
        const handle = el.querySelector(".resize-handle");
        let isResizing = false, lastX, lastY;
        handle.addEventListener("mousedown", e => {
          isResizing = true;
          lastX = e.clientX;
          lastY = e.clientY;
          e.preventDefault();
        });
        window.addEventListener("mousemove", e => {
          if (isResizing) {
            const dx = e.clientX - lastX, dy = e.clientY - lastY;
            el.style.width = el.offsetWidth + dx + "px";
            el.style.height = el.offsetHeight + dy + "px";
            lastX = e.clientX;
            lastY = e.clientY;
          }
        });
        window.addEventListener("mouseup", () => { isResizing = false; });
      }
      function updateTaskbar() {
        const container = document.getElementById("open-apps");
        container.innerHTML = "";
        openApps.forEach(appId => {
          const app = installedApps.find(app => app.appId === appId);
          if (app) {
            const img = document.createElement("img");
            img.src = app.image;
            img.alt = app.name;
            img.title = app.name;
            img.style.width = "32px";
            img.style.height = "32px";
            img.style.cursor = "pointer";
            img.onclick = () => bringToFront(appId);
            container.appendChild(img);
          }
        });
      }
      function bringToFront(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) document.body.appendChild(appWindow);
      }
      function powerOff() {
        document.body.innerHTML = `
          <div class="shutdown-screen">
            <h2>Shutting down...</h2>
            <p>Goodbye!</p>
            <button onclick="location.reload()">Reboot</button>
          </div>
        `;
      }

      /* Setup Screen */
      function showSetupScreen() {
        const container = document.createElement("div");
        container.classList.add("setup-screen");
        document.body.appendChild(container);
        let currentStep = 1;
        const data = { username: "", password: "", profilePic: "", wallpaper: "", osTheme: "", colorScheme: "" };
        function renderStep() {
          switch (currentStep) {
            case 1:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Let's get you setup</h2>
                  <p>Please choose your username and password.</p>
                  <input type="text" id="setup-username" placeholder="Username" />
                  <div>
                    <input type="password" id="setup-password" placeholder="Password" />
                    <button class="toggle-password" onclick="toggleInputPassword('setup-password', this)">
                      <img src="images/icons/setup/show.png" alt="Show" />
                    </button>
                  </div>
                  <button id="setup-next">Next</button>
                </div>
              `;
              document.getElementById("setup-next").addEventListener("click", () => {
                const u = document.getElementById("setup-username").value.trim();
                const p = document.getElementById("setup-password").value.trim();
                if (u && p) { data.username = u; data.password = p; currentStep++; renderStep(); }
                else { alert("Username and password cannot be empty!"); }
              });
              break;
            case 2:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Choose a Profile Picture</h2>
                  <p>This is optional. Upload one if you like:</p>
                  <div class="file-input-wrapper">
                    <span class="file-input-label">Choose File</span>
                    <input type="file" id="profile-upload" accept="image/*" />
                  </div>
                  <img id="profile-preview" class="preview-img" src="images/icons/profile/profile.png" alt="Profile Preview" />
                  <br />
                  <button id="setup-skip">Skip</button>
                  <button id="setup-next">Next</button>
                </div>
              `;
              document.getElementById("profile-upload").addEventListener("change", e => {
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = evt => {
                    document.getElementById("profile-preview").src = evt.target.result;
                    data.profilePic = evt.target.result;
                  };
                  reader.readAsDataURL(file);
                }
              });
              document.getElementById("setup-skip").addEventListener("click", () => { data.profilePic = "images/icons/profile/profile.png"; currentStep++; renderStep(); });
              document.getElementById("setup-next").addEventListener("click", () => { if (!data.profilePic) data.profilePic = "images/icons/profile/profile.png"; currentStep++; renderStep(); });
              break;
            case 3:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Choose your Default Wallpaper</h2>
                  <p>Select a wallpaper for your desktop.</p>
                  <select id="setup-wallpaper-select">
                    ${(() => {
                      let opts = "";
                      for (let i = 1; i <= 41; i++) {
                        opts += `<option value="images/backgrounds/wallpaper${i}.jpg">Wallpaper ${i}</option>`;
                      }
                      return opts;
                    })()}
                  </select>
                  <br />
                  <img id="wallpaper-preview" class="preview-img" src="images/backgrounds/wallpaper1.jpg" alt="Wallpaper Preview" />
                  <br />
                  <button id="setup-next">Next</button>
                </div>
              `;
              document.getElementById("setup-wallpaper-select").addEventListener("change", e => {
                const sel = e.target.value;
                document.getElementById("wallpaper-preview").src = sel;
                data.wallpaper = sel;
              });
              document.getElementById("setup-next").addEventListener("click", () => {
                if (!data.wallpaper) data.wallpaper = document.getElementById("setup-wallpaper-select").value;
                currentStep++;
                renderStep();
              });
              break;
            case 4:
              container.innerHTML = `
                <div class="setup-step">
                  <h2>Setup OS Theme & Color Scheme</h2>
                  <p>Select your OS theme and color scheme.</p>
                  <div style="margin-bottom:10px;">
                    <label>OS Theme:</label>
                    <select id="setup-ostheme">
                      <option value="default">Default</option>
                      <option value="windows10">Windows10</option>
                    </select>
                  </div>
                  <div style="margin-bottom:10px;">
                    <label>Color Scheme:</label>
                    <select id="setup-colorscheme">
                      <option value="dark">Dark</option>
                      <option value="light">Light</option>
                    </select>
                  </div>
                  <button id="setup-finish">Finish</button>
                </div>
              `;
              const colorSchemeSelect = document.getElementById("setup-colorscheme");
              colorSchemeSelect.addEventListener("change", () => toggleLightDark(this.value));
              document.getElementById("setup-finish").addEventListener("click", () => {
                data.osTheme = document.getElementById("setup-ostheme").value;
                data.colorScheme = document.getElementById("setup-colorscheme").value;
                toggleLightDark(data.colorScheme);
                localStorage.setItem("username", data.username);
                localStorage.setItem("password", data.password);
                localStorage.setItem("profilePic", data.profilePic);
                localStorage.setItem("background", data.wallpaper);
                localStorage.setItem("osTheme", data.osTheme);
                localStorage.setItem("colorScheme", data.colorScheme);
                localStorage.setItem("setupComplete", "true");
                changeBackgroundimage(data.wallpaper);
                sessionStorage.removeItem("loggedIn");
                container.remove();
                showBootScreen();
              });
              break;
            default:
              break;
          }
        }
        renderStep();
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadInstalledApps().then(() => {
          loadBackground();
          if (!localStorage.getItem("setupComplete")) {
            showSetupScreen();
          } else {
            showBootScreen();
          }
        });
      });

      /* Background functions */
      function loadBackground() {
        const background = localStorage.getItem("background");
        if (background) document.body.style.background = background;
      }
      function saveBackground(backgroundValue) {
        localStorage.setItem("background", backgroundValue);
        loadBackground();
      }
      function changeBackground(r, g, b) {
        const color = `rgb(${r}, ${g}, ${b})`;
        document.body.style.background = color;
        saveBackground(color);
      }
      function changeBackgroundimage(url) {
        const bg = `url(${url}) center center/cover no-repeat fixed`;
        document.body.style.background = bg;
        saveBackground(bg);
      }

      /* Desktop and Taskbar Functions */
      function renderDesktop() {
        const desktop = document.getElementById("desktop");
        if (!desktop) return;
        desktop.innerHTML = "";
        installedApps.forEach(app => {
          const appShortcut = document.createElement("div");
          appShortcut.classList.add("desktop-app");
          appShortcut.innerHTML = `<img src="${app.image}" alt="${app.name} icon" /><span>${app.name}</span>`;
          appShortcut.onclick = () => openAppWindow(app.appId);
          desktop.appendChild(appShortcut);
        });
      }
      function openAppWindow(appId) {
        const app = installedApps.find(app => app.appId === appId);
        if (app) {
          if (document.getElementById(appId)) return;
          const appWindow = document.createElement("div");
          appWindow.classList.add("app-window");
          appWindow.id = appId;
          appWindow.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close" />
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen" />
                </button>
              </div>
            </div>
            <div class="window-content">
              ${app.htmlContent ? app.htmlContent : `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(appWindow);
          makeDraggable(appWindow);
          makeResizable(appWindow);
          openApps.push(appId);
          updateTaskbar();
          if (appId === "jstore") setTimeout(loadJstoreApps, 100);
          if (appId === "settings") setTimeout(initSettingsApp, 100);
        }
      }
      function closeWindow(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) {
          appWindow.remove();
          openApps = openApps.filter(id => id !== appId);
          updateTaskbar();
        }
      }
      function toggleFullscreen(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) {
          if (appWindow.style.position === "fixed") {
            appWindow.style.position = "absolute";
            appWindow.style.width = "600px";
            appWindow.style.height = "400px";
            appWindow.style.zIndex = "";
          } else {
            appWindow.style.position = "fixed";
            appWindow.style.top = "0";
            appWindow.style.left = "0";
            appWindow.style.width = "100vw";
            appWindow.style.height = "100vh";
            appWindow.style.zIndex = "10000";
          }
        }
      }
      function makeDraggable(el) {
        const header = el.querySelector(".window-header") || el;
        let isDragging = false, offsetX = 0, offsetY = 0;
        header.addEventListener("mousedown", e => {
          isDragging = true;
          offsetX = e.clientX - el.offsetLeft;
          offsetY = e.clientY - el.offsetTop;
        });
        el.addEventListener("mousemove", e => {
          if (isDragging) {
            el.style.left = `${e.clientX - offsetX}px`;
            el.style.top = `${e.clientY - offsetY}px`;
          }
        });
        el.addEventListener("mouseup", () => { isDragging = false; });
      }
      function makeResizable(el) {
        const handle = el.querySelector(".resize-handle");
        let isResizing = false, lastX, lastY;
        handle.addEventListener("mousedown", e => {
          isResizing = true;
          lastX = e.clientX;
          lastY = e.clientY;
          e.preventDefault();
        });
        window.addEventListener("mousemove", e => {
          if (isResizing) {
            const dx = e.clientX - lastX, dy = e.clientY - lastY;
            el.style.width = el.offsetWidth + dx + "px";
            el.style.height = el.offsetHeight + dy + "px";
            lastX = e.clientX;
            lastY = e.clientY;
          }
        });
        window.addEventListener("mouseup", () => { isResizing = false; });
      }
      function updateTaskbar() {
        const container = document.getElementById("open-apps");
        container.innerHTML = "";
        openApps.forEach(appId => {
          const app = installedApps.find(app => app.appId === appId);
          if (app) {
            const img = document.createElement("img");
            img.src = app.image;
            img.alt = app.name;
            img.title = app.name;
            img.style.width = "32px";
            img.style.height = "32px";
            img.style.cursor = "pointer";
            img.onclick = () => bringToFront(appId);
            container.appendChild(img);
          }
        });
      }
      function bringToFront(appId) {
        const appWindow = document.getElementById(appId);
        if (appWindow) document.body.appendChild(appWindow);
      }
      function powerOff() {
        document.body.innerHTML = `
          <div class="shutdown-screen">
            <h2>Shutting down...</h2>
            <p>Goodbye!</p>
            <button onclick="location.reload()">Reboot</button>
          </div>
        `;
      }

      /* Jfi Modal Functions */
      document.getElementById("closeJfiModal")?.addEventListener("click", () => {
        document.getElementById("jfiModal").style.display = "none";
      });
      document.getElementById("connectJfiBtn")?.addEventListener("click", () => {
        const url = document.getElementById("jfiWsUrl").value;
        const status = document.getElementById("jfiStatus");
        try {
          const ws = new WebSocket(url);
          ws.onopen = () => {
            status.textContent = "Connected to Jfi!";
            status.style.color = "lime";
          };
          ws.onmessage = msg => {
            console.log("Jfi Message:", msg.data);
          };
          ws.onerror = e => {
            status.textContent = "Error connecting!";
            status.style.color = "red";
          };
          ws.onclose = () => {
            status.textContent = "Disconnected.";
          };
        } catch (e) {
          status.textContent = "Invalid WebSocket URL.";
          status.style.color = "red";
        }
      });

      /* System Menu and Brightness */
      function attachSystemMenuListener() {
        const sysBtn = document.getElementById("systemMenuBtn");
        const miniMenu = document.getElementById("miniMenu");
        if (sysBtn && miniMenu) {
          sysBtn.addEventListener("click", () => {
            if (miniMenu.style.display === "block") {
              miniMenu.style.display = "none";
            } else {
              const rect = sysBtn.getBoundingClientRect();
              miniMenu.style.left = rect.left + "px";
              miniMenu.style.bottom = (window.innerHeight - rect.top + 5) + "px";
              miniMenu.style.display = "block";
            }
          });
        }
        const jfiBtn = document.getElementById("jfiButton");
        if (jfiBtn) {
          jfiBtn.addEventListener("click", () => {
            document.getElementById("jfiModal").style.display = "block";
          });
        }
        const brightnessSlider = document.getElementById("brightnessSlider");
        if (brightnessSlider) {
          brightnessSlider.addEventListener("input", updateBrightness);
        }
      }
      function updateBrightness() {
        const brightnessSlider = document.getElementById("brightnessSlider");
        if (brightnessSlider) {
          const val = brightnessSlider.value;
          const osContainer = document.getElementById("osContainer");
          if (osContainer) {
            osContainer.style.filter = "brightness(" + val + "%)";
          }
        }
      }

      /* Game Bar Functions */
      function toggleGameBar() {
        const gb = document.getElementById("gamebar");
        if (gb.style.display === "none" || gb.style.display === "") {
          gb.style.display = "flex";
          document.getElementById("gm-icon").src = "images/icons/gm/on.png";
          gmApps = installedApps.filter(app => app.name !== "Settings" && app.name !== "Jstore");
          if (gmApps.length > 0) {
            gmCurrentIndex = Math.floor(Math.random() * gmApps.length);
            updateGMLauncher();
          }
          startGamepadPolling();
        } else {
          gb.style.display = "none";
          document.getElementById("gm-icon").src = "images/icons/gm/off.png";
          stopGamepadPolling();
        }
      }
      function updateGMLauncher() {
        const launcher = document.getElementById("gm-launcher");
        if (gmApps.length === 0) {
          launcher.innerHTML = "No apps available";
          return;
        }
        const app = gmApps[gmCurrentIndex];
        launcher.innerHTML = `<img src="${app.image}" alt="${app.name} icon" />${app.name}`;
      }
      function cycleApp(direction) {
        if (gmApps.length === 0) return;
        gmCurrentIndex = (gmCurrentIndex + direction + gmApps.length) % gmApps.length;
        updateGMLauncher();
      }
      function launchGMApp() {
        if (gmApps.length === 0) return;
        const app = gmApps[gmCurrentIndex];
        if (app.htmlUrl) {
          let url = app.htmlUrl;
          url += (url.indexOf("?") === -1) ? "?controller=true" : "&controller=true";
          openAppWindowWithUrl(app.appId, url);
        } else {
          openAppWindow(app.appId);
        }
      }
      function openAppWindowWithUrl(appId, url) {
        const app = installedApps.find(app => app.appId === appId);
        if (app && !document.getElementById(appId)) {
          const win = document.createElement("div");
          win.classList.add("app-window");
          win.id = appId;
          win.innerHTML = `
            <div class="window-header">
              <span class="window-title">${app.name}</span>
              <div>
                <button class="window-btn" onclick="closeWindow('${appId}')">
                  <img src="images/icons/x.png" alt="Close" />
                </button>
                <button class="window-btn" onclick="toggleFullscreen('${appId}')">
                  <img src="images/icons/fullscreen.png" alt="Fullscreen" />
                </button>
              </div>
            </div>
            <div class="window-content">
              ${app.htmlContent ? app.htmlContent : `<iframe src="${app.htmlUrl}" width="100%" height="100%" style="border:none;"></iframe>`}
            </div>
            <div class="resize-handle"></div>
          `;
          document.body.appendChild(win);
          makeDraggable(win);
          makeResizable(win);
          openApps.push(appId);
          updateTaskbar();
        }
      }
      function startGamepadPolling() {
        if (gamepadInterval) return;
        gamepadInterval = setInterval(() => {
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          if (!gamepads) return;
          for (let gp of gamepads) {
            if (gp) {
              if (gp.buttons[14] && gp.buttons[14].pressed) { cycleApp(-1); }
              if (gp.buttons[15] && gp.buttons[15].pressed) { cycleApp(1); }
              if (gp.buttons[0] && gp.buttons[0].pressed) { launchGMApp(); }
              const axis = gp.axes[0];
              if (axis < -0.5) { cycleApp(-1); }
              if (axis > 0.5) { cycleApp(1); }
            }
          }
        }, 100);
      }
      function stopGamepadPolling() {
        if (gamepadInterval) {
          clearInterval(gamepadInterval);
          gamepadInterval = null;
        }
      }

      /* Boot Screen and OS Loading */
      function showBootScreen() {
        document.body.innerHTML = `
          <div id="boot-screen" class="boot-screen">
            <div class="boot-content">
              <span class="boot-title" style="font-size:4em;">Jx</span>
              <div class="loading-circle"></div>
            </div>
          </div>
        `;
        setTimeout(() => { loadOS(); showPasswordModal(); }, 2000);
      }
      function loadOS() {
        document.body.innerHTML = `
          <div id="osContainer">
            <div id="gamebar" style="display: none;">
              <button id="gm-left" onclick="cycleApp(-1)">&#9664;</button>
              <div id="gm-launcher" onclick="launchGMApp()"></div>
              <button id="gm-right" onclick="cycleApp(1)">&#9654;</button>
              <div id="gm-clock"></div>
              <button id="gm-widgets-btn" onclick="toggleWidgetsMenu()">Widgets</button>
            </div>
            <div id="miniMenu">
              <div class="menuItem" id="jfiButton">
                <img src="images/icons/minimenu/jfi.png" alt="Jfi" />
                <span>Jfi</span>
              </div>
              <div class="menuItem">
                <img src="images/icons/minimenu/connect.png" alt="Connect" />
                <span>Connect</span>
              </div>
              <div class="menuItem">
                <img src="images/icons/minimenu/brightness.png" alt="Brightness" />
                <input type="range" id="brightnessSlider" min="0" max="100" value="100" />
              </div>
              <div class="batteryInfo">
                <div id="batteryContainerSys">
                  <div id="batteryLevelSys" style="width: 0%;"></div>
                </div>
                <span id="batteryPercentBottom">--%</span>
              </div>
            </div>
            <div id="desktop"></div>
            <div id="search-menu" class="search-menu" style="display: none;">
              <span class="close-btn" onclick="toggleSearchMenu()">
                <img src="images/icons/x.png" alt="Close" />
              </span>
              <input type="text" placeholder="Search apps..." oninput="filterApps(this.value)" />
              <div id="app-list"></div>
            </div>
          </div>
          <div id="taskbar" class="taskbar">
            <button id="start-button" class="taskbar-button" onclick="toggleSearchMenu()">❖</button>
            <button id="gm-button" class="taskbar-button" onclick="toggleGameBar()">
              <img id="gm-icon" src="images/icons/gm/off.png" alt="Game Mode" />
            </button>
            <div id="open-apps"></div>
            <div id="taskbar-right">
              <div id="clock-container">
                <span id="date"></span>
                <span id="clock"></span>
              </div>
              <button id="systemMenuBtn" class="taskbar-button">
                <img src="images/icons/wifi.png" alt="WiFi" style="width:32px;height:32px;" />
                <div id="batteryContainer">
                  <div id="batteryLevel" style="width: 0%;"></div>
                </div>
                <span id="batteryPercent">--%</span>
              </button>
              <button class="lock-button" onclick="showPasswordModal()">Lock</button>
              <button onclick="powerOff()" class="power-button">Power Down</button>
            </div>
          </div>
          <div id="search-menu" class="search-menu" style="display: none;">
            <span class="close-btn" onclick="toggleSearchMenu()">
              <img src="images/icons/x.png" alt="Close" />
            </span>
            <input type="text" placeholder="Search apps..." oninput="filterApps(this.value)" />
            <div id="app-list"></div>
          </div>
        `;
        installJstoreIfNotInstalled();
        installSettingsIfNotInstalled();
        renderDesktop();
        updateTaskbar();
        restoreOSTheme();
        setInterval(updateClock, 1000);
        setInterval(updateBatteryInfo, 1000);
        initWidgetsMenu();
        attachSystemMenuListener();
      }

      /* Background functions */
      function loadBackground() {
        const background = localStorage.getItem("background");
        if (background) document.body.style.background = background;
      }
      function saveBackground(backgroundValue) {
        localStorage.setItem("background", backgroundValue);
        loadBackground();
      }
      function changeBackground(r, g, b) {
        const color = `rgb(${r}, ${g}, ${b})`;
        document.body.style.background = color;
        saveBackground(color);
      }
      function changeBackgroundimage(url) {
        const bg = `url(${url}) center center/cover no-repeat fixed`;
        document.body.style.background = bg;
        saveBackground(bg);
      }

      /* Jfi Modal Functions */
      document.getElementById("closeJfiModal")?.addEventListener("click", () => {
        document.getElementById("jfiModal").style.display = "none";
      });
      document.getElementById("connectJfiBtn")?.addEventListener("click", () => {
        const url = document.getElementById("jfiWsUrl").value;
        const status = document.getElementById("jfiStatus");
        try {
          const ws = new WebSocket(url);
          ws.onopen = () => {
            status.textContent = "Connected to Jfi!";
            status.style.color = "lime";
          };
          ws.onmessage = msg => {
            console.log("Jfi Message:", msg.data);
          };
          ws.onerror = e => {
            status.textContent = "Error connecting!";
            status.style.color = "red";
          };
          ws.onclose = () => {
            status.textContent = "Disconnected.";
          };
        } catch (e) {
          status.textContent = "Invalid WebSocket URL.";
          status.style.color = "red";
        }
      });
    </script>
  </body>
</html>